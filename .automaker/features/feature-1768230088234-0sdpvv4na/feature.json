{
    "category": "backend",
    "dependencies": [],
    "description": "Add TOTP-based multi-factor authentication with recovery codes.\n\nCurrently: `Crypto.Key.encrypt` in `packages/server/src/crypto.ts:120-131` encrypts via AES-GCM. `EncryptionKeyService` provides encryption key. `SessionAuth` middleware in `packages/server/src/middleware.ts:62-88` handles auth. No MFA infrastructure exists. `otplib` not in catalog.\n\nDeliverables:\n1. Add `otplib: ^14.0.0` to catalog in `pnpm-workspace.yaml`, run `pnpm install`\n2. Add `mfa_secrets` pgTable in `packages/types/src/schema.ts`: `userId` (FK users, unique PK), `secretEncrypted` (bytea NOT NULL), `backupCodesHash` (text[] NOT NULL), `enabledAt` (timestamp nullable)\n3. Create migration `packages/database/migrations/NNNN_mfa.ts` (use next sequential number)\n4. Add `MfaSecretsRepository` in `packages/database/src/repos.ts` with methods: `findByUserId(userId)`, `upsert(data)`, `delete(userId)`\n5. Create `packages/server/src/mfa.ts` with `MfaService` class extending `Effect.Service`:\n   - `enroll(userId)` - generates secret via `otplib.authenticator.generateSecret()`, encrypts with `Crypto.Key.encrypt`, returns QR data URL\n   - `verify(userId, code)` - decrypts secret, validates via `otplib.authenticator.verify()`\n   - `useRecoveryCode(userId, code)` - validates code against `backupCodesHash`, removes used code\n6. Add endpoints in api.ts: `POST /api/mfa/enroll` (returns QR), `POST /api/mfa/verify` (validates 6-digit code), `DELETE /api/mfa` (disables MFA), `POST /api/mfa/recover` (uses recovery code)\n\nAcceptance: `pnpm exec nx run-many -t typecheck -p database,server` passes. Enroll returns QR data URL. Verify with correct 6-digit code succeeds. Recovery code can only be used once.",
    "descriptionHistory": [],
    "id": "feature-1768230088234-0sdpvv4na",
    "startedAt": "2026-01-12T19:08:10.158Z",
    "status": "verified",
    "title": "TOTP multi-factor authentication",
    "updatedAt": "2026-01-12T19:23:35.861Z"
}
