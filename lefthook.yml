# --- [PRE_COMMIT_HOOKS] -------------------------------------------------------
pre-commit:
  parallel: true
  commands:
    biome:
      glob: "*"
      run: pnpm exec biome check --write --no-errors-on-unmatched --files-ignore-unknown=true --colors=off {staged_files}
      stage_fixed: true
      skip: false
    imperatives:
      glob: "*.{ts,tsx}"
      exclude:
        - "*.d.ts"
        - "**/node_modules/**"
        - ".github/scripts/**"
        - "tools/scripts/**"
        - "infrastructure/**"
        - "**/suspense.ts"
        - "**/*.spec.ts"
        - "**/*.test.ts"
        - "**/overlay/*.tsx"
        - "**/server/src/utils/transfer.ts"
      run: |
        violation=0
        for file in {staged_files}; do
          matches=$(grep -nE '\b(try\s*\{|throw\s+|let\s+|var\s+|for\s*\(|while\s*\(|if\s*\()' "$file" 2>/dev/null | grep -vE '^[0-9]+:\s*(//|\*|/\*)|Symbol\.for|Effect\.if' || true)
          if [ -n "$matches" ]; then
            echo "[ERROR] Imperative pattern in $file"
            echo "$matches"
            violation=1
          fi
        done
        [ "$violation" -eq 0 ] || { echo "Use: Effect.try/fail, const, .map/.filter, ternary/dispatch"; exit 1; }
      skip: false

# --- [PRE_PUSH_HOOKS] ---------------------------------------------------------
pre-push:
  parallel: false
  commands:
    quality:
      env:
        NX_DAEMON: "false"
        FORCE_COLOR: "0"
      run: pnpm exec nx affected -t typecheck,check --base=origin/main --output-style=stream
