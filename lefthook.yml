# --- [PRE_COMMIT_HOOKS] -------------------------------------------------------
pre-commit:
  parallel: true
  skip:
    - merge
    - rebase
  commands:
    biome:
      glob: "*"
      run: pnpm exec biome check --write --no-errors-on-unmatched --files-ignore-unknown=true --colors=off {staged_files}
      stage_fixed: true

    sonar-rules:
      glob: "*.{ts,tsx}"
      exclude:
        - "*.d.ts"
        - "**/node_modules/**"
        - "**/*.spec.ts"
        - "**/*.test.ts"
        - "**/*.bench.ts"
      run: pnpm exec eslint -c eslint.sonar.config.js {staged_files}
      fail_text: "[SONARJS] Code smell detected - fix before committing"

    typos:
      glob: "*"
      exclude:
        - "**/node_modules/**"
        - "**/*.lock"
        - "**/pnpm-lock.yaml"
        - "**/*.svg"
        - "**/*.png"
        - "**/*.jpg"
        - "**/*.ico"
      run: typos {staged_files}
      fail_text: "[TYPOS] Spelling error detected - fix before committing"

    imperatives:
      glob: "*.{ts,tsx}"
      exclude:
        - "*.d.ts"
        - "**/node_modules/**"
        - ".github/scripts/**"
        - "tools/scripts/**"
        - "**/suspense.ts"
        - "**/*.spec.ts"
        - "**/*.test.ts"
        - "**/overlay/*.tsx"
      run: |
        violation=0
        for file in {staged_files}; do
          matches=$(grep -nE '\b(try\s*\{|throw\s+|let\s+|var\s+|for\s*\(|while\s*\(|if\s*\()' "$file" 2>/dev/null | grep -vE '^[0-9]+:\s*(//|\*|/\*)' || true)
          if [ -n "$matches" ]; then
            echo "[ERROR] Imperative pattern in $file"
            echo "$matches"
            violation=1
          fi
        done
        [ "$violation" -eq 0 ] || { echo "Use: Effect.try/fail, const, .map/.filter, ternary/dispatch"; exit 1; }

# --- [PRE_PUSH_HOOKS] ---------------------------------------------------------
pre-push:
  parallel: false
  skip:
    - merge
    - rebase
  commands:
    quality:
      env:
        NX_DAEMON: "false"
        FORCE_COLOR: "0"
      run: pnpm exec nx affected -t typecheck,check --base=origin/main --output-style=stream
      fail_text: "[QUALITY] Type or lint errors detected - fix before pushing"

    sonar:
      env:
        NX_DAEMON: "false"
        FORCE_COLOR: "0"
      run: pnpm exec nx affected -t sonar --base=origin/main --parallel=1
      fail_text: "[SONAR] SonarQube analysis failed"
