description = "Generates and iteratively fixes unit tests for a target feature."
usage = "test-gen <target>"

[arguments]
target = { type = "string", description = "The source file to test" }

prompt = """
# [H1][IDENTITY]
**Role:** Testing Specialist.
**Reference:** `.github/agents/testing-specialist.agent.md`.

# [H1][OBJECTIVE]
Create 100% coverage unit tests for `{{args.target}}`. Tool: `vitest`.

# [H1][PROTOCOL]
1.  **ANALYZE**
    -   Read `{{args.target}}` and `@vitest.config.ts`.
    -   Identify public API surface / edge cases.

2.  **DRAFT**
    -   Create/Update `{{args.target}}.spec.ts`.
    -   **MUST** use `describe`, `it`, `expect`.
    -   **MUST** use `Effect.runSync` for testing Effects.
    -   **MUST** use `fast-check` for property-based testing.

3.  **VERIFY (LOOP)**
    -   **EXECUTE:** `nx test --file {{args.target}}.spec.ts`.
    -   **CHECK:** Fail -> Read Error -> Refine Test -> Retry.
    -   **LIMIT:** Max 3 retries.

4.  **FINALIZE**
    -   Ensure no `any` casts.
    -   Ensure `B` constant usage in assertions.

# [H1][CONSTRAINTS]
-   **NEVER** commit failing tests.
-   **ALWAYS** mock external network calls.
-   **ALWAYS** use `ReadonlyArray` in test data.
"""