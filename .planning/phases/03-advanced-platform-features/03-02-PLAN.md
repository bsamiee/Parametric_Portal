---
phase: 03-advanced-platform-features
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - packages/server/src/platform/workers/transfer.ts
autonomous: true

must_haves:
  truths:
    - "Worker script runs in worker_threads context"
    - "Worker handles ParseTransfer requests via RPC server"
    - "Worker fetches from presigned URLs directly (no auth credentials)"
    - "Worker streams progress events during parsing"
    - "Worker returns partial results + errors on completion"
  artifacts:
    - path: "packages/server/src/platform/workers/transfer.ts"
      provides: "Worker script for transfer parsing"
      contains: "NodeWorkerRunner"
  key_links:
    - from: "packages/server/src/platform/workers/transfer.ts"
      to: "packages/server/src/platform/workers/contract.ts"
      via: "import TransferRpc, ParseTransfer"
      pattern: "import.*contract"
    - from: "transfer.ts worker"
      to: "@effect/rpc RpcServer"
      via: "TransferRpc.toLayer"
      pattern: "RpcServer\\.layer"
---

<objective>
Create the worker script that handles transfer parsing operations in a separate thread.

Purpose: Move CPU-intensive xlsx/zip/csv parsing off the main thread to prevent blocking the API event loop. Worker receives presigned URLs, parses files, and streams progress back to the main thread.

Output:
- `transfer.ts` worker script with RPC server handling ParseTransfer requests
- Streaming progress updates during parsing
- Partial results + errors on completion
</objective>

<execution_context>
@/Users/bardiasamiee/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bardiasamiee/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-advanced-platform-features/03-CONTEXT.md
@.planning/phases/03-advanced-platform-features/03-RESEARCH.md
@.planning/phases/03-advanced-platform-features/03-01-SUMMARY.md
@packages/server/src/platform/workers/contract.ts
@packages/server/src/utils/transfer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Worker Script with RPC Server</name>
  <files>packages/server/src/platform/workers/transfer.ts</files>
  <action>
Create `packages/server/src/platform/workers/transfer.ts` - the worker script that runs in worker_threads:

1. **Imports:**
   ```typescript
   import * as NodeWorkerRunner from "@effect/platform-node/NodeWorkerRunner";
   import * as NodeRuntime from "@effect/platform-node/NodeRuntime";
   import * as RpcServer from "@effect/rpc/RpcServer";
   import { Effect, Layer, Option, Stream, Chunk, Either, Data } from "effect";
   import { TransferRpc, ParseProgress, ParseResult, ParseError, type ParseFormat } from "./contract.ts";
   ```

2. **DRIVERS section:** Lazy-load parsing libraries (same pattern as existing transfer.ts):
   ```typescript
   const _drivers = {
     excel: () => Effect.promise(() => import('exceljs')),
     papa:  () => Effect.promise(() => import('papaparse')),
     sax:   () => Effect.promise(() => import('sax')),
     yaml:  () => Effect.promise(() => import('yaml')),
     zip:   () => Effect.promise(async () => (await import('jszip')).default),
   } as const;
   ```

3. **PARSING section:** Adapt existing parsing functions from utils/transfer.ts:
   - Create internal parsing functions for xlsx, csv, zip, json, yaml, xml, ndjson
   - Key difference: These return `Stream<ParseProgress | ParseResult>` instead of `Stream<Either<Asset, ParseError>>`
   - Track progress: bytesProcessed, rowsProcessed, percentage, ETA calculation

4. **PROGRESS section:** Helper to emit progress:
   ```typescript
   const _emitProgress = (
     bytesProcessed: number,
     totalBytes: number,
     rowsProcessed: number,
     startTime: number,
   ): ParseProgress => ({
     bytesProcessed,
     totalBytes,
     rowsProcessed,
     percentage: totalBytes > 0 ? (bytesProcessed / totalBytes) * 100 : 0,
     eta: Option.fromNullable(
       totalBytes > 0 && bytesProcessed > 0
         ? ((Date.now() - startTime) / bytesProcessed) * (totalBytes - bytesProcessed)
         : null
     ),
   });
   ```

5. **HANDLER section:** ParseTransfer handler:
   ```typescript
   const parseHandler = ({ presignedUrl, format }: { presignedUrl: string; format: ParseFormat }) =>
     Stream.unwrap(Effect.gen(function* () {
       // Fetch file from presigned URL
       const response = yield* Effect.tryPromise({
         catch: (e) => new ParseError({ code: 'PARSER_ERROR', detail: String(e) }),
         try: () => fetch(presignedUrl),
       });

       if (!response.ok) {
         return Stream.fail(new ParseError({
           code: 'PARSER_ERROR',
           detail: `HTTP ${response.status}: ${response.statusText}`,
         }));
       }

       const totalBytes = Number(response.headers.get("content-length") ?? 0);
       const body = response.body;

       if (!body) {
         return Stream.fail(new ParseError({ code: 'PARSER_ERROR', detail: 'No response body' }));
       }

       // Dispatch to format-specific parser
       return parseWithProgress(body, format, totalBytes);
     }));
   ```

6. **RPC SERVER section:**
   ```typescript
   const Live = TransferRpc.toLayer(
     Effect.succeed({
       ParseTransfer: parseHandler,
     }),
   );

   const RpcWorkerServer = RpcServer.layer(TransferRpc).pipe(
     Layer.provide(Live),
     Layer.provide(RpcServer.layerProtocolWorkerRunner),
     Layer.provide(NodeWorkerRunner.layer),
   );
   ```

7. **ENTRYPOINT section:**
   ```typescript
   NodeRuntime.runMain(NodeWorkerRunner.launch(RpcWorkerServer));
   ```

Key implementation details:
- Worker is STATELESS - receives URL, returns parsed result
- No auth credentials passed - presigned URLs only
- Progress emission every 100 rows or 10KB (throttled)
- Final result includes both successful items AND parse errors (partial results)
- Uses Data.TaggedError for all error types

Adapt parsing logic from existing `packages/server/src/utils/transfer.ts`:
- _delimited (csv, tsv) -> papa.parse
- _xlsx -> exceljs stream reader
- _zip -> jszip with manifest support
- _streamed (json, yaml, ndjson) -> line-based parsing
- _tree (xml) -> sax parser

Each parser should:
1. Track bytes/rows processed
2. Emit progress every 100 rows
3. Accumulate parse errors (Either.left) into errors array
4. Return final ParseResult with items + errors
  </action>
  <verify>
```bash
pnpm exec nx run server:typecheck
```
Worker script compiles. Note: Runtime testing requires full integration (Plan 04).
  </verify>
  <done>
- Worker script created at packages/server/src/platform/workers/transfer.ts
- RPC server handles ParseTransfer requests
- Fetches from presigned URLs (no auth credentials)
- Streams progress during parsing (bytesProcessed, rowsProcessed, percentage, eta)
- Returns ParseResult with items array + errors array (partial results)
- All error types are Data.TaggedError (ParseError, TimeoutError, WorkerCrashError)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Worker Build Configuration</name>
  <files>packages/server/vite.config.ts</files>
  <action>
Check if worker bundling configuration is needed for Vite:

1. **Inspect current vite.config.ts** to understand build setup

2. **If using Vite for Node.js build:** May need to ensure worker script is bundled separately or handled correctly. Options:
   - Add worker entry to rollupOptions.input
   - Or use `build.lib` with multiple entries
   - Or rely on Effect's runtime to load the worker as a module

3. **If using esbuild/tsx directly:** Worker script should work as-is with TypeScript

Per RESEARCH.md open question: "Vite Worker Bundling for Node.js - May need separate esbuild/rollup config for worker scripts"

Check the current build approach and add minimal configuration if needed. If the current build copies TypeScript files or uses tsx runtime, no changes may be needed.

Document any configuration added or why none was needed.
  </action>
  <verify>
```bash
# Check if worker file is accessible after build
pnpm exec nx run server:build
ls -la dist/packages/server/src/platform/workers/ 2>/dev/null || echo "Check build output structure"
```
  </verify>
  <done>
- Build configuration reviewed
- Worker script either bundled correctly OR documented why no config needed
- Worker file accessible in build output (or via tsx runtime in dev)
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **TypeScript compilation:**
   ```bash
   pnpm exec nx run server:typecheck
   ```

2. **Worker script structure:**
   - Imports from contract.ts
   - RpcServer.layer with TransferRpc
   - NodeWorkerRunner.launch entrypoint

3. **Build verification:**
   ```bash
   pnpm exec nx run server:build
   ```
</verification>

<success_criteria>
- Worker script compiles without errors
- RPC server pattern matches research documentation
- Progress streaming implemented with ETA calculation
- Partial results pattern (items + errors arrays)
- Build includes worker script (or runtime loads it)
</success_criteria>

<output>
After completion, create `.planning/phases/03-advanced-platform-features/03-02-SUMMARY.md`
</output>
