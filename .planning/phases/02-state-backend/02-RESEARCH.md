# Phase 2: State Backend - Research

**Researched:** 2026-02-13 (refreshed 2026-02-13)
**Domain:** Pulumi S3 state backend + AWS KMS secrets encryption
**Confidence:** HIGH

## Summary

Phase 2 configures Pulumi to store state in an S3 bucket with AWS KMS envelope encryption for secrets, replacing the current unconfigured (effectively local/default) backend. The primary challenge is the bootstrap chicken-and-egg problem: the S3 bucket and KMS key that Pulumi needs must themselves be provisioned. The standard solution is a dedicated bootstrap Pulumi project that runs against a local filesystem backend, creates the S3 bucket + KMS key, then the main infrastructure project is configured to use those resources as its backend and secrets provider.

The scope is narrow but foundational: one S3 bucket (versioned, KMS-encrypted, public-access-blocked), one KMS key (with alias, rotation enabled), backend URL configuration in `Pulumi.yaml`, and stack initialization with the `--secrets-provider` flag. No code changes to `deploy.ts` are required -- the existing `pulumi.secret()` calls already mark values correctly; the secrets provider change only affects how those marked values are encrypted at rest in the state file. Pulumi's transitive secret tracking ensures that any output derived from a secret input is also encrypted in state.

A secondary concern surfaced during research: Pulumi's file-based state locking in S3 is not as robust as DynamoDB-based locking (Terraform pattern). Network failures can leave stale locks requiring `pulumi cancel`. For a single-team setup this is acceptable, but the pitfall should be documented.

**Primary recommendation:** Create a bootstrap Pulumi project (`infrastructure/bootstrap/`) that provisions the state bucket and KMS key via `pulumi login --local`, then configure the main `infrastructure/Pulumi.yaml` with `backend.url` pointing to the S3 bucket. Initialize stacks with `--secrets-provider="awskms://alias/parametric-pulumi?region=<region>"`. Enable encryption context (v3.41.1+) for CloudTrail auditability.

## Standard Stack

### Core

| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| `@pulumi/pulumi` | 3.220.0 | CLI + SDK for state backend interaction | Already in catalog; `pulumi login`, `pulumi stack init` are CLI commands |
| `@pulumi/aws` | 7.19.0 | Bootstrap project creates S3 bucket + KMS key | Already in catalog; provisions the backend infrastructure |

### Supporting

| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| `@pulumi/random` | 4.18.5 | Unique suffix for bucket name (optional) | Only if bucket name collision is a concern beyond account-ID scoping |

No new dependencies are required. Everything needed is already in the `pnpm-workspace.yaml` catalog.

### Alternatives Considered

| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Bootstrap Pulumi project | AWS CLI / CloudFormation | Loses IaC-as-code consistency; one-off manual step |
| AWS KMS secrets provider | Passphrase secrets provider | Passphrase requires `PULUMI_CONFIG_PASSPHRASE` env var management; KMS integrates with existing AWS IAM |
| S3 file-based locking | DynamoDB locking (community) | Pulumi's built-in S3 file locking is sufficient for single-team; DynamoDB adds complexity |
| Dedicated state bucket | Reuse existing `parametric-assets-${stack}` bucket | State bucket should be separate from application data; different lifecycle, retention, access patterns |
| `aws.s3.BucketV2` | `aws.s3.Bucket` | BucketV2 is **deprecated** in @pulumi/aws v7, removed in v8. Use non-V2 resources. |

### Resource API Note

In @pulumi/aws 7.x, the `V2` suffixed S3 resources (`BucketV2`, `BucketVersioningV2`, `BucketServerSideEncryptionConfigurationV2`) are deprecated and will be removed in v8. The non-V2 names (`Bucket`, `BucketVersioning`, `BucketServerSideEncryptionConfiguration`) are the current standard. The existing `deploy.ts` already uses the correct non-V2 resources.

Source: [Pulumi AWS Provider 7.0 blog](https://www.pulumi.com/blog/announcing-7-0-of-the-pulumi-aws-provider/)

## Architecture Patterns

### Recommended Project Structure

```
infrastructure/
+-- bootstrap/                  # NEW: one-time state backend provisioning
|   +-- Pulumi.yaml             # name: parametric-bootstrap, runtime: nodejs
|   +-- Pulumi.bootstrap.yaml   # Stack config (local backend, no secrets provider)
|   +-- package.json            # @pulumi/aws, @pulumi/pulumi only
|   +-- tsconfig.json
|   +-- .gitignore              # Ignores .pulumi/backups/ and .pulumi/history/
|   +-- src/
|       +-- index.ts            # Creates S3 bucket + KMS key + alias
+-- Pulumi.yaml                 # MODIFIED: adds backend.url field
+-- Pulumi.dev.yaml             # NEW: auto-generated by pulumi stack init --secrets-provider
+-- Pulumi.prod.yaml            # NEW: auto-generated by pulumi stack init --secrets-provider
+-- src/
|   +-- platform.ts             # UNCHANGED
|   +-- deploy.ts               # UNCHANGED
|   +-- runtime-env.ts          # UNCHANGED
+-- ...
```

### Pattern 1: Bootstrap with Local Backend

**What:** A separate Pulumi project that provisions the state bucket and KMS key using `pulumi login --local` (filesystem backend). Once created, the main project configures its `Pulumi.yaml` to use the S3 backend.

**When to use:** Always -- this is the standard pattern for self-managed backends.

**Workflow:**

```bash
# Step 1: Bootstrap (one-time)
cd infrastructure/bootstrap
pulumi login --local
pulumi stack init bootstrap
pulumi config set aws:region us-east-1
pulumi up --yes

# Step 2: Get outputs
STATE_BUCKET=$(pulumi stack output stateBucketName)
KMS_ALIAS=$(pulumi stack output kmsKeyAlias)

# Step 3: Configure main project
cd ../
# Pulumi.yaml already has backend.url configured (replace ACCOUNT_ID placeholder)
pulumi login "s3://${STATE_BUCKET}?region=us-east-1&awssdk=v2"
pulumi stack init dev --secrets-provider="awskms://alias/${KMS_ALIAS}?region=us-east-1"
pulumi stack init prod --secrets-provider="awskms://alias/${KMS_ALIAS}?region=us-east-1"
```

Source: [Pulumi State and Backends docs](https://www.pulumi.com/docs/iac/concepts/state-and-backends/), [Bootstrap pattern (justedagain.com)](https://justedagain.com/posts/2022/pulumi-backend-bootstrap/)

### Pattern 2: Pulumi.yaml Backend URL Configuration

**What:** Declare the backend URL in `Pulumi.yaml` so all developers and CI automatically use the S3 backend without manual `pulumi login`.

**When to use:** Always after bootstrap completes.

**Example:**

```yaml
# infrastructure/Pulumi.yaml
name: parametric
runtime: nodejs
main: src/platform.ts
description: Parametric Portal infrastructure -- zero-YAML IAC
backend:
  url: s3://parametric-pulumi-state-ACCOUNT_ID?region=us-east-1&awssdk=v2
```

**Precedence:** The `PULUMI_BACKEND_URL` environment variable overrides the `backend.url` in `Pulumi.yaml`. This is useful for CI/CD environments that may need a different backend URL at runtime.

Source: [Pulumi State and Backends docs](https://www.pulumi.com/docs/iac/concepts/state-and-backends/), [Pulumi Environment Variables docs](https://www.pulumi.com/docs/iac/cli/environment-variables/)

### Pattern 3: Stack Config with KMS Secrets Provider

**What:** Each `Pulumi.<stack>.yaml` file stores the secrets provider URL and encrypted data key. Created automatically by `pulumi stack init --secrets-provider`.

**When to use:** Automatically created per stack.

**Example (auto-generated):**

```yaml
# infrastructure/Pulumi.dev.yaml
secretsprovider: awskms://alias/parametric-pulumi?region=us-east-1
encryptedkey: AQECAHgFl1+CIJQc3Tn...base64...
config: {}
```

**Envelope encryption mechanism:** The `encryptedkey` field is a base64-encoded data key encrypted by KMS. When Pulumi runs, it calls KMS `Decrypt` to unwrap this data key, then uses the plaintext data key to encrypt/decrypt individual secret values in state. This means KMS is called once per operation (to decrypt the data key), not once per secret value.

Source: [Pulumi Secrets Handling docs](https://www.pulumi.com/docs/iac/concepts/secrets/), [Pulumi Cloud Secret Providers blog](https://www.pulumi.com/blog/peace-of-mind-with-cloud-secret-providers/)

### Pattern 4: Encryption Context for Auditability (v3.41.1+)

**What:** Add `context_{key}={value}` query parameters to the KMS secrets provider URL. These appear in CloudTrail logs and can be used in IAM policy conditions.

**When to use:** Recommended for production stacks for auditability.

**Example:**

```bash
pulumi stack init dev \
  --secrets-provider="awskms://alias/parametric-pulumi?region=us-east-1&context_project=parametric&context_stack=dev"
```

This enables IAM conditions like `kms:EncryptionContext:project` to restrict which projects can use the KMS key, and CloudTrail entries will show which project/stack triggered each KMS operation.

Source: [Pulumi Secrets Handling docs](https://www.pulumi.com/docs/iac/concepts/secrets/)

### Anti-Patterns to Avoid

- **Using passphrase secrets provider with S3 backend:** Requires distributing `PULUMI_CONFIG_PASSPHRASE` to all operators and CI. KMS uses IAM -- no shared secrets needed.
- **Storing state in the application S3 bucket:** State has different lifecycle, retention, and access control requirements. Dedicated bucket is standard.
- **Manual bucket/key creation via AWS Console:** Loses reproducibility. Bootstrap project ensures the backend infra is IaC-managed.
- **Skipping bucket versioning:** State corruption without versioning is unrecoverable. Versioning enables rollback via `pulumi stack export/import`.
- **Wide KMS key policy:** Granting `kms:*` on the key to broad principals undermines the security benefit of KMS encryption.
- **Using V2-suffixed S3 resources:** `BucketV2`, `BucketVersioningV2`, etc. are deprecated in @pulumi/aws 7.x. Use the non-V2 names.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| State locking | Custom DynamoDB lock table | Pulumi built-in S3 file locking | Built-in since v3.x; file-based locks in `.pulumi/locks/` directory |
| Secret encryption | Custom AES wrapper | `--secrets-provider="awskms://..."` flag | Pulumi handles envelope encryption with data keys; `pulumi.secret()` marks values |
| State migration | Manual JSON editing | `pulumi stack export --show-secrets` + `pulumi stack import` | Official migration path preserves all resource URNs |
| KMS key rotation | Manual re-encryption | `enableKeyRotation: true` on KMS key | AWS handles annual rotation transparently; old ciphertext still decryptable |
| State compression | Custom gzip layer | `PULUMI_DIY_BACKEND_GZIP=1` env var | Built-in gzip support for state files; reduces S3 storage and transfer time |
| Lock recovery | Manual S3 object deletion | `pulumi cancel` command | Safely removes stale lock files in `.pulumi/locks/` |

**Key insight:** Pulumi's state backend and secrets provider are independent, composable systems. The S3 backend handles where state lives; the KMS provider handles how secrets within state are encrypted. Both are configured declaratively and require zero custom code.

## Common Pitfalls

### Pitfall 1: Chicken-and-Egg Bootstrap

**What goes wrong:** Attempting to create the state bucket using Pulumi with S3 backend -- but the bucket does not exist yet, so `pulumi login` fails.
**Why it happens:** Circular dependency between "need backend to run Pulumi" and "need Pulumi to create backend."
**How to avoid:** Dedicated bootstrap project using `pulumi login --local`. The bootstrap state is committed to git or stored locally (it is small and non-sensitive -- only bucket/key metadata).
**Warning signs:** `pulumi login s3://...` fails with "bucket does not exist."

### Pitfall 2: Missing awssdk=v2 Query Parameter

**What goes wrong:** `pulumi login s3://bucket` fails with authentication errors or uses legacy SDK behavior.
**Why it happens:** Pulumi defaults to AWS SDK v1 for S3 backend. v2 is required for modern credential resolution (SSO, profiles, IMDS v2).
**How to avoid:** Always include `?awssdk=v2` in the S3 backend URL.
**Warning signs:** Credential errors when AWS CLI works fine; profile not respected.

Source: [Pulumi docs](https://www.pulumi.com/docs/iac/concepts/state-and-backends/) (CLI v3.33.1+)

### Pitfall 3: Forgetting --secrets-provider on Stack Init

**What goes wrong:** Stack is created with default passphrase provider. All secrets require `PULUMI_CONFIG_PASSPHRASE` or are encrypted with Pulumi Cloud key.
**Why it happens:** `pulumi stack init <name>` without `--secrets-provider` uses the default provider.
**How to avoid:** Always pass `--secrets-provider="awskms://alias/parametric-pulumi?region=<region>"` on `pulumi stack init`. Can be fixed after the fact with `pulumi stack change-secrets-provider`.
**Warning signs:** Prompted for passphrase on `pulumi up`; `encryptionsalt` in stack yaml instead of `encryptedkey`.

### Pitfall 4: Project-Scoped Stacks Compatibility

**What goes wrong:** Stack files in S3 are not found by other team members or CI.
**Why it happens:** Pulumi v3.61.0+ creates project-scoped stacks by default in new backends. Stacks are stored at `.pulumi/stacks/<project>/<stack>.json` instead of `.pulumi/stacks/<stack>.json`.
**How to avoid:** This is the correct behavior for new backends. Ensure all team members use Pulumi CLI >= 3.61.0. The catalog has 3.220.0, which is well past this version. Note: `pulumi state upgrade` migrates existing backends to project-scoped layout -- this is a one-way operation incompatible with older Pulumi versions.
**Warning signs:** `pulumi stack ls` shows empty list despite state files existing in S3.

### Pitfall 5: KMS Key Deletion Window Too Short

**What goes wrong:** KMS key is deleted (7-day minimum window), all encrypted state secrets become permanently unrecoverable.
**Why it happens:** Default deletion window is 30 days, but can be set as low as 7. Accidental `pulumi destroy` on bootstrap stack could schedule key deletion.
**How to avoid:** Set `deletionWindowInDays: 30` and `protect: true` on the KMS key resource. Also enable `enableKeyRotation: true` for compliance.
**Warning signs:** Key shows "Pending deletion" status in AWS Console.

### Pitfall 6: Bucket Namespace Collision

**What goes wrong:** S3 bucket creation fails because the name is globally taken.
**Why it happens:** S3 bucket names are globally unique across all AWS accounts.
**How to avoid:** Use a project-specific prefix with account ID: `parametric-pulumi-state-${accountId}`. Account ID is not sensitive and is deterministic.
**Warning signs:** `BucketAlreadyExists` error on `pulumi up`.

### Pitfall 7: Stale Lock Files After Network Failure

**What goes wrong:** `pulumi up` fails with "the stack is currently locked" even though no operation is running.
**Why it happens:** Network failure or process kill during a Pulumi operation leaves a lock file in `.pulumi/locks/` in S3. Unlike DynamoDB-based locking (Terraform), S3 file-based locks have no TTL.
**How to avoid:** Run `pulumi cancel` to remove stale lock files. For CI/CD, ensure graceful shutdown of Pulumi processes (avoid `kill -9`). The lock file path is shown in the error message.
**Warning signs:** Error message includes "the stack is currently locked by X operations" when no operations are running.

Source: [GitHub #8984](https://github.com/pulumi/pulumi/issues/8984)

### Pitfall 8: Missing IAM Permissions for S3 + KMS

**What goes wrong:** `AccessDenied` errors when running `pulumi up` or `pulumi login`.
**Why it happens:** Insufficient S3 or KMS permissions for the IAM principal running Pulumi.
**How to avoid:** The IAM principal needs minimum permissions:
- **S3:** `s3:GetObject`, `s3:PutObject`, `s3:ListBucket`, `s3:DeleteObject` on the state bucket and its contents
- **KMS:** `kms:Encrypt`, `kms:Decrypt`, `kms:GenerateDataKey` on the secrets KMS key
- **Note:** After v3.59.0, Pulumi also writes `.pulumi/Pulumi.yaml` metadata at the bucket root level, so path-restricted IAM policies must include this path.
**Warning signs:** `AccessDenied` error mentioning `.pulumi/Pulumi.yaml` or specific S3 object paths.

Source: [GitHub #12534](https://github.com/pulumi/pulumi/issues/12534)

### Pitfall 9: Secret Inputs Appearing in pulumi stack export

**What goes wrong:** Running `pulumi stack export --show-secrets=false` may show resource input properties in plaintext even when marked as secret.
**Why it happens:** There is a known issue (GitHub #13286) where `pulumi stack export` does not always encrypt input properties in the export output, even when `--show-secrets=false`. However, this is a display issue in the export command -- the actual state file stored in S3 encrypts values that are marked via `pulumi.secret()` or transitive secret tracking.
**How to avoid:** Always wrap sensitive values with `pulumi.secret()` (the existing codebase already does this correctly). Use `additionalSecretOutputs` for any computed outputs that derive from secrets but are not automatically tracked. The verification command `pulumi stack export | grep -c "plaintext"` remains valid for checking the persisted state file, but be aware that the export display format has this known edge case.
**Warning signs:** Seeing unencrypted values in `pulumi stack export` output for properties you expected to be encrypted.

Source: [GitHub #13286](https://github.com/pulumi/pulumi/issues/13286)

## Code Examples

### Bootstrap Project: S3 Bucket + KMS Key (TypeScript)

```typescript
// Source: Pulumi Registry (aws.kms.Key, aws.s3.Bucket)
// infrastructure/bootstrap/src/index.ts

import * as aws from '@pulumi/aws';
import * as pulumi from '@pulumi/pulumi';

const account = aws.getCallerIdentityOutput();
const region = aws.getRegionOutput();

// KMS key for Pulumi secrets encryption
const key = new aws.kms.Key('pulumi-secrets-key', {
    description: 'Encrypts Pulumi stack secrets for Parametric Portal',
    enableKeyRotation: true,
    deletionWindowInDays: 30,
}, { protect: true });

const alias = new aws.kms.Alias('pulumi-secrets-alias', {
    name: 'alias/parametric-pulumi',
    targetKeyId: key.id,
});

// S3 bucket for Pulumi state storage
const bucket = new aws.s3.Bucket('pulumi-state-bucket', {
    bucket: pulumi.interpolate`parametric-pulumi-state-${account.accountId}`,
    forceDestroy: false,
}, { protect: true });

new aws.s3.BucketVersioning('pulumi-state-versioning', {
    bucket: bucket.id,
    versioningConfiguration: { status: 'Enabled' },
});

new aws.s3.BucketServerSideEncryptionConfiguration('pulumi-state-encryption', {
    bucket: bucket.id,
    rules: [{
        applyServerSideEncryptionByDefault: {
            kmsMasterKeyId: key.arn,
            sseAlgorithm: 'aws:kms',
        },
        bucketKeyEnabled: true,
    }],
});

new aws.s3.BucketPublicAccessBlock('pulumi-state-public-block', {
    bucket: bucket.id,
    blockPublicAcls: true,
    blockPublicPolicy: true,
    ignorePublicAcls: true,
    restrictPublicBuckets: true,
});

export const stateBucketName = bucket.bucket;
export const stateBucketArn = bucket.arn;
export const kmsKeyId = key.id;
export const kmsKeyArn = key.arn;
export const kmsKeyAlias = alias.name;
export const loginCommand = pulumi.interpolate`pulumi login 's3://${bucket.bucket}?region=${region.id}&awssdk=v2'`;
export const secretsProvider = pulumi.interpolate`awskms://alias/parametric-pulumi?region=${region.id}`;
```

**Notes on this code:**
- `bucketKeyEnabled: true` reduces KMS API costs by using an S3 bucket-level key for server-side encryption, rather than calling KMS per-object.
- `protect: true` prevents `pulumi destroy` from deleting these resources (requires explicit `--unprotect` override).
- The KMS key uses the default key policy (grants full access to the AWS account root). This is sufficient for single-account usage; for cross-account access, a custom key policy would be needed.
- No `@pulumi/tls` reference in bootstrap -- only `@pulumi/aws` and `@pulumi/pulumi` are needed.

### Modified Pulumi.yaml (Main Project)

```yaml
# Source: Pulumi State and Backends docs
# infrastructure/Pulumi.yaml
name: parametric
runtime: nodejs
main: src/platform.ts
description: Parametric Portal infrastructure -- zero-YAML IAC
# [NOTE] Replace ACCOUNT_ID with your AWS account ID after running bootstrap.
# Get it via: cd bootstrap && pulumi stack output stateBucketName
# Or: aws sts get-caller-identity --query Account --output text
backend:
  url: s3://parametric-pulumi-state-ACCOUNT_ID?region=us-east-1&awssdk=v2
```

### Stack Init with KMS Provider (with Encryption Context)

```bash
# Source: Pulumi Secrets Handling docs
cd infrastructure/
pulumi stack init dev \
  --secrets-provider="awskms://alias/parametric-pulumi?region=us-east-1&context_project=parametric&context_stack=dev"
pulumi stack init prod \
  --secrets-provider="awskms://alias/parametric-pulumi?region=us-east-1&context_project=parametric&context_stack=prod"
```

### Verification Commands

```bash
# Verify no plaintext secrets in state
pulumi stack export | grep -c "plaintext"
# Expected: 0

# Verify secrets provider in stack config
grep "secretsprovider" Pulumi.dev.yaml
# Expected: secretsprovider: awskms://alias/parametric-pulumi?region=us-east-1...

# Verify encryptedkey (not encryptionsalt) is present
grep "encryptedkey" Pulumi.dev.yaml
# Expected: encryptedkey: AQECAH... (base64 KMS-encrypted data key)

# Verify state is in S3 (not local)
aws s3 ls s3://parametric-pulumi-state-ACCOUNT_ID/.pulumi/ --recursive
# Expected: lists stacks/, history/, meta.yaml

# Verify protected resources in bootstrap
cd infrastructure/bootstrap
pulumi stack export | jq '.deployment.resources[] | select(.protect == true) | .urn'
# Expected: KMS key and S3 bucket URNs
```

### IAM Policy for Pulumi Operators (Reference)

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "PulumiStateBucketAccess",
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:DeleteObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::parametric-pulumi-state-ACCOUNT_ID",
        "arn:aws:s3:::parametric-pulumi-state-ACCOUNT_ID/*"
      ]
    },
    {
      "Sid": "PulumiKmsSecretsAccess",
      "Effect": "Allow",
      "Action": [
        "kms:Encrypt",
        "kms:Decrypt",
        "kms:GenerateDataKey"
      ],
      "Resource": "arn:aws:kms:us-east-1:ACCOUNT_ID:key/KEY_ID"
    }
  ]
}
```

This is a reference for Phase 8 (CI/CD) -- not needed during bootstrap but documents the minimum permissions for future automation.

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Flat stack naming in DIY backends | Project-scoped stacks (`project/stack`) | Pulumi v3.61.0 (Apr 2023) | Multi-project S3 backends no longer collide |
| AWS SDK v1 for S3 backend | AWS SDK v2 (`?awssdk=v2`) | Pulumi v3.33.1 | Profile/SSO/IMDS v2 credential resolution works correctly |
| `PULUMI_CONFIG_PASSPHRASE` only | Cloud KMS providers (awskms, gcpkms, etc.) | Pulumi v1.x (2019) | IAM-based access control replaces shared passphrase |
| `encryptionsalt` (passphrase) | `encryptedkey` (KMS envelope encryption) | Pulumi v1.x | Envelope encryption: KMS encrypts a data key, data key encrypts secrets |
| DynamoDB required for locking (Terraform pattern) | Built-in file-based locking in S3 | Always (Pulumi design) | No extra infrastructure needed for state locking |
| No encryption context | `context_{key}={value}` in KMS provider URL | Pulumi v3.41.1 | CloudTrail auditability and IAM condition keys |
| Uncompressed state files | `PULUMI_DIY_BACKEND_GZIP=1` | Available since v3.x | Reduces state file size (16MiB -> <1MiB in large stacks) |
| `BucketV2`, `BucketVersioningV2` etc. | Non-V2 names (`Bucket`, `BucketVersioning`) | @pulumi/aws v7.0 | V2 deprecated, removed in v8 |

**Deprecated/outdated:**
- `PULUMI_DIY_BACKEND_LEGACY_LAYOUT`: Pre-v3.61.0 flat layout. Suppresses warning but should not be used for new backends.
- AWS SDK v1 (default without `?awssdk=v2`): Still works but missing modern credential chain features.
- `BucketV2`, `BucketVersioningV2`, `BucketServerSideEncryptionConfigurationV2`: Deprecated in @pulumi/aws v7, removed in v8. Use non-V2 names.

## Environment Variables Reference

| Variable | Purpose | When Needed |
|----------|---------|-------------|
| `PULUMI_BACKEND_URL` | Override `backend.url` from `Pulumi.yaml` | CI/CD override; takes precedence over file config |
| `PULUMI_CONFIG_PASSPHRASE` | Passphrase for local bootstrap encryption | Only during bootstrap `pulumi login --local` |
| `PULUMI_DIY_BACKEND_GZIP` | Enable gzip compression of state files | Optional; recommended for large stacks |
| `PULUMI_DIY_BACKEND_DISABLE_CHECKPOINT_BACKUPS` | Disable checkpoint backup files | Optional; reduces S3 storage if versioning handles rollback |
| `PULUMI_DIY_BACKEND_RETAIN_CHECKPOINTS` | Retain timestamped checkpoint copies | Optional; additional history beyond S3 versioning |
| `PULUMI_DIY_BACKEND_LEGACY_LAYOUT` | Use legacy flat stack layout | Never for new backends; only for backward compat |
| `PULUMI_DIY_BACKEND_NO_LEGACY_WARNING` | Suppress legacy layout warning | Only if using legacy layout intentionally |

## Open Questions

1. **AWS Region for State Bucket**
   - What we know: The project uses `us-east-1` for cloud mode resources.
   - What's unclear: Whether the state bucket should be in the same region as application resources or a different region for disaster recovery.
   - Recommendation: Same region (`us-east-1`) for simplicity. Cross-region replication can be added later if needed.

2. **Bucket Naming Strategy**
   - What we know: Application bucket uses `parametric-assets-${stack}`. Bootstrap needs a globally unique name.
   - What's unclear: Whether to include AWS account ID, random suffix, or fixed name.
   - Recommendation: `parametric-pulumi-state-${accountId}` -- deterministic, unique, identifiable. Account ID is not sensitive.

3. **Bootstrap State Storage**
   - What we know: Bootstrap project uses `pulumi login --local`, producing a `.pulumi` directory.
   - What's unclear: Whether to commit bootstrap state to git or store it externally.
   - Recommendation: Commit to git (it is small, non-sensitive -- just bucket/key ARNs). Add to `.gitignore` the `.pulumi/backups/` and `.pulumi/history/` subdirectories to avoid bloat. The bootstrap is truly one-time and resources have `protect: true`, so even losing the local state is recoverable (just re-import).

4. **Encryption Context Usage**
   - What we know: Pulumi v3.41.1+ supports `context_{key}={value}` in the KMS provider URL for CloudTrail auditability.
   - What's unclear: Whether to add encryption context now (Phase 2) or defer to Phase 8 (CI/CD).
   - Recommendation: Add during stack init in Phase 2 -- it is a one-time configuration and provides immediate CloudTrail value. Use `context_project=parametric&context_stack=${stack}`.

5. **CI/CD Environment Variables**
   - What we know: `PULUMI_BACKEND_URL` env var can override `Pulumi.yaml` backend URL. AWS credentials needed for both S3 access and KMS decryption.
   - What's unclear: Exact GitHub Actions secret names to use. Phase 8 will handle CI/CD in detail.
   - Recommendation: Document the required env vars and minimum IAM policy now; implement in Phase 8.

6. **State Compression**
   - What we know: `PULUMI_DIY_BACKEND_GZIP=1` compresses state files significantly (reported 16x reduction).
   - What's unclear: Whether to enable by default or only for large stacks.
   - Recommendation: Defer until state grows large. Not needed for Phase 2 -- the initial state will be small.

## Sources

### Primary (HIGH confidence)
- [Pulumi State and Backends docs](https://www.pulumi.com/docs/iac/concepts/state-and-backends/) - S3 backend URL format, login command, project-scoped stacks, file-based locking, `.pulumi` directory structure
- [Pulumi Secrets Handling docs](https://www.pulumi.com/docs/iac/concepts/secrets/) - awskms provider URL format (ID/alias/ARN), encryption context support (v3.41.1+), `--secrets-provider` flag, `encryptedkey` vs `encryptionsalt`
- [Pulumi Stack Settings File Reference](https://www.pulumi.com/docs/iac/concepts/projects/stack-settings-file/) - `Pulumi.<stack>.yaml` format: secretsprovider, encryptedkey, encryptionsalt fields
- [Pulumi Environment Variables docs](https://www.pulumi.com/docs/iac/cli/environment-variables/) - `PULUMI_BACKEND_URL`, `PULUMI_CONFIG_PASSPHRASE`, `PULUMI_DIY_BACKEND_*` variables
- [Pulumi Registry: aws.kms.Key](https://www.pulumi.com/registry/packages/aws/api-docs/kms/key/) - KMS key TypeScript API, enableKeyRotation, deletionWindowInDays, key policy
- [Pulumi additionalSecretOutputs docs](https://www.pulumi.com/docs/iac/concepts/resources/options/additionalsecretoutputs/) - Resource option for marking output properties as secrets
- [Pulumi AWS Provider 7.0 blog](https://www.pulumi.com/blog/announcing-7-0-of-the-pulumi-aws-provider/) - V2 resource deprecation, migration to non-V2 names
- [Pulumi Cloud Secret Providers blog](https://www.pulumi.com/blog/peace-of-mind-with-cloud-secret-providers/) - Envelope encryption mechanism, encryptedkey field, KMS data key pattern
- [Pulumi Managing Secrets blog](https://www.pulumi.com/blog/managing-secrets-with-pulumi/) - Transitive secret tracking, `pulumi.secret()` behavior, state file encryption of inputs and outputs

### Secondary (MEDIUM confidence)
- [Pulumi Project-Scoped Stacks blog](https://www.pulumi.com/blog/project-scoped-stacks-in-self-managed-backend/) - v3.61.0 introduction, upgrade path, `organization/project/stack` naming
- [Bootstrap Pulumi Self-Managed Backend (justedagain.com)](https://justedagain.com/posts/2022/pulumi-backend-bootstrap/) - Bootstrap pattern: local backend -> create S3/KMS -> migrate. Verified against official docs.
- [Bootstrap Pulumi Self-Managed Backend (eriklz.online)](https://eriklz.online/posts/bootstrap-pulumi-self-managed-backend/) - CloudFormation + Pulumi dual bootstrap approach; `protect: true` pattern. Verified.
- [Nelson Figueroa: S3 Backend Guide](https://nelson.cloud/how-to-use-an-aws-s3-bucket-as-a-pulumi-state-backend/) - Practical walkthrough; `Pulumi.yaml` backend.url field. Verified.
- [Nelson Figueroa: GitHub Actions for Pulumi S3 Backend](https://nelson.cloud/github-actions-for-pulumi-with-an-aws-s3-backend/) - CI/CD patterns for S3 backend. Reference for Phase 8.
- [GitHub #12534: AccessDenied after v3.59.0](https://github.com/pulumi/pulumi/issues/12534) - Metadata file write permission requirement; resolved in PR #12537.
- [GitHub #8984: S3 locking issues with Automation API](https://github.com/pulumi/pulumi/issues/8984) - Stale lock behavior, `pulumi cancel` recovery.
- [GitHub #13286: Plaintext inputs in stack export](https://github.com/pulumi/pulumi/issues/13286) - Export display issue; state file itself encrypts `pulumi.secret()` values.
- [AWS S3 Bucket Keys documentation](https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucket-key.html) - Cost reduction via bucket-level KMS keys.

### Tertiary (LOW confidence)
- None. All findings verified against official Pulumi documentation or authoritative GitHub issues.

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - All components already in catalog; no new dependencies needed; verified against v7.19.0 and v3.220.0
- Architecture: HIGH - Bootstrap pattern is well-documented across official docs and multiple verified community sources; encryption context feature verified in official docs
- Pitfalls: HIGH - All pitfalls sourced from official documentation, verified GitHub issues, or verified community reports; nine pitfalls identified (up from six) including stale locks, IAM permissions, and export display edge case
- IAM/Security: MEDIUM - Minimum permissions derived from multiple sources but no single official "minimum IAM policy" document from Pulumi; cross-verified with AWS documentation

**Research date:** 2026-02-13
**Valid until:** 2026-03-15 (stable domain; Pulumi backend/secrets APIs change infrequently)
