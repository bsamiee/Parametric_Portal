---
phase: 05-eventbus-reliability
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - packages/server/src/observe/devtools.ts
  - packages/server/src/platform/streaming.ts
autonomous: true

must_haves:
  truths:
    - "DevTools layer connects in non-production when available"
    - "StreamingService.channel() marked deprecated with migration note"
  artifacts:
    - path: "packages/server/src/observe/devtools.ts"
      provides: "DevTools tracer layer with availability check"
      min_lines: 20
      contains: "DevToolsLayer"
    - path: "packages/server/src/platform/streaming.ts"
      provides: "Deprecation annotation on channel method"
      contains: "@deprecated"
  key_links:
    - from: "packages/server/src/observe/devtools.ts"
      to: "@effect/experimental"
      via: "DevTools.Client import"
      pattern: "DevTools\\.Client"
---

<objective>
DevTools layer for development debugging and StreamingService deprecation.

Purpose: Enable Effect DevTools tracer in non-production environments when available. Mark StreamingService.channel() as deprecated with migration path to EventBus.subscribe().

Output:
- DevToolsLayer with WebSocket availability check and automatic connection
- StreamingService.channel() with @deprecated JSDoc annotation pointing to EventBus
</objective>

<execution_context>
@/Users/bardiasamiee/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bardiasamiee/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-eventbus-reliability/05-RESEARCH.md
@.planning/phases/05-eventbus-reliability/05-CONTEXT.md
@packages/server/src/observe/telemetry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DevTools layer</name>
  <files>packages/server/src/observe/devtools.ts</files>
  <action>
Create DevTools layer file at packages/server/src/observe/devtools.ts:

```typescript
/**
 * DevTools: Optional development tracer via @effect/experimental.
 * Auto-connects when DevTools server available in non-production.
 */
import { DevTools } from '@effect/experimental';
import { NodeSocket } from '@effect/platform-node';
import { Config, Duration, Effect, Layer, Option } from 'effect';

// --- [CONSTANTS] -------------------------------------------------------------

const _CONFIG = { timeout: Duration.seconds(1), url: 'ws://localhost:34437' } as const;

// --- [LAYERS] ----------------------------------------------------------------

// DevToolsLayer with inline tracer and connection test
const DevToolsLayer = Layer.unwrapEffect(
  Effect.all({
    env: Config.string('NODE_ENV').pipe(Config.withDefault('development')),
    enabled: Config.boolean('DEVTOOLS_ENABLED').pipe(Config.withDefault(false)),
  }).pipe(
    Effect.map(({ env, enabled }) => env !== 'production' && enabled),
    Effect.filterOrElse(
      (shouldConnect) => shouldConnect,
      () => Effect.succeed(Layer.empty),
    ),
    Effect.flatMap(() =>
      Effect.async<boolean>((resume) => {
        const ws = new WebSocket(_CONFIG.url);
        ws.onopen = () => {
          ws.close();
          resume(Effect.succeed(true));
        };
        ws.onerror = () => {
          ws.close();
          resume(Effect.succeed(false));
        };
        return Effect.sync(() => ws.close());
      }).pipe(
        Effect.timeout(_CONFIG.timeout),
        Effect.map(Option.getOrElse(() => false)),
      ),
    ),
    Effect.filterOrElse(
      (available) => available,
      () => Effect.logDebug('DevTools server unavailable').pipe(Effect.as(Layer.empty)),
    ),
    Effect.flatMap(() =>
      Effect.logInfo('DevTools tracer enabled').pipe(
        Effect.as(
          DevTools.Client.layerTracer.pipe(
            Layer.provide(NodeSocket.layerWebSocket(_CONFIG.url)),
          ),
        ),
      ),
    ),
  ),
);

// --- [EXPORT] ----------------------------------------------------------------

export { DevToolsLayer };
```

Pattern: Follow research template exactly - config-driven, availability check, graceful degradation.

NOTE: This layer is optional and only used in development. It connects to Effect DevTools for visual debugging of effects.
  </action>
  <verify>
1. Run `pnpm exec nx run server:typecheck` - No type errors
2. DevToolsLayer exported
3. Layer only connects when NODE_ENV !== 'production' AND DEVTOOLS_ENABLED === true AND server available
  </verify>
  <done>DevTools layer ready for optional development debugging</done>
</task>

<task type="auto">
  <name>Task 2: Deprecate StreamingService.channel()</name>
  <files>packages/server/src/platform/streaming.ts</files>
  <action>
Locate StreamingService in streaming.ts and add deprecation annotation to channel() method.

1. Find the channel() method or channel property in StreamingService
2. Add JSDoc deprecation annotation:

```typescript
/**
 * @deprecated Use EventBus.subscribe() for cross-pod event delivery.
 * channel() only works within a single pod. EventBus provides:
 * - Cluster-wide broadcast via Sharding.broadcaster
 * - Typed domain events via VariantSchema
 * - At-least-once delivery with deduplication
 * - Transactional outbox (events only publish after commit)
 *
 * Migration:
 * ```typescript
 * // Before (single-pod only)
 * const stream = yield* StreamingService.channel('topic');
 *
 * // After (cluster-wide)
 * const stream = yield* EventBus.subscribe('order', (e) =>
 *   Effect.logInfo('Order event', e)
 * );
 * ```
 */
```

3. If channel() doesn't exist yet (might not be implemented), note this for the summary.

4. Check for any broadcast() method and deprecate similarly if found:

```typescript
/**
 * @deprecated Use EventBus.emit() for cross-pod event publishing.
 */
```

NOTE: streaming.ts may not have channel() implemented yet. If so, just document that no deprecation was needed.
  </action>
  <verify>
1. Check if channel() exists in streaming.ts
2. If exists, verify @deprecated annotation added
3. Run `pnpm exec nx run server:typecheck` - No type errors
  </verify>
  <done>StreamingService.channel() marked deprecated with EventBus migration path</done>
</task>

</tasks>

<verification>
1. `pnpm exec nx run server:typecheck` - No type errors
2. DevToolsLayer exports correctly
3. DevTools only connects in non-production with DEVTOOLS_ENABLED=true
4. StreamingService.channel() has @deprecated annotation (if method exists)
</verification>

<success_criteria>
- DevToolsLayer created with WebSocket availability check
- DevTools only connects when env != production AND enabled AND server available
- StreamingService.channel() marked deprecated with migration example
- All files typecheck successfully
</success_criteria>

<output>
After completion, create `.planning/phases/05-eventbus-reliability/05-03-SUMMARY.md`
</output>
