---
phase: 03-shared-config-schema
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/config/package.json
  - packages/config/tsconfig.json
  - packages/config/vite.config.ts
  - packages/config/src/env.ts
  - packages/config/src/tenant.ts
autonomous: true

must_haves:
  truths:
    - "A packages/config package exists with only effect as a runtime dependency -- no workspace package imports, no UI deps"
    - "The env var contract is expressed as composed Effect sub-schemas (PostgresEnv, RedisEnv, StorageEnv, EmailEnv, TelemetryEnv, ClusterEnv, OAuthEnv, AppEnv) that compose into a single RuntimeEnvSchema"
    - "Each env var field has the correct Effect Schema type (String, NumberFromString, BooleanFromString, optional with default, Redacted for secrets)"
    - "Schema.decodeUnknownSync(RuntimeEnvSchema)(process.env) succeeds for a valid env and throws a structured ParseError for invalid env"
    - "TenantConfigSchema defines the tenant configuration contract (mode, domain, resource limits) consumed by both IaC and runtime"
    - "All 17 missing env vars from the gap analysis are present in the schema (EMAIL_*, RESEND_*, POSTMARK_*, SES_*, SMTP_*, POSTGRES_SSL, REDIS_TLS_CA)"
  artifacts:
    - path: "packages/config/package.json"
      provides: "Package manifest with effect dependency only"
      contains: "@parametric-portal/config"
    - path: "packages/config/src/env.ts"
      provides: "RuntimeEnvSchema composed from sub-schemas with all env vars documented"
      exports: ["RuntimeEnvSchema", "PostgresEnv", "RedisEnv", "StorageEnv", "EmailEnv", "TelemetryEnv", "ClusterEnv", "AppEnv"]
    - path: "packages/config/src/tenant.ts"
      provides: "TenantConfigSchema for tenant provisioning contract"
      exports: ["TenantConfigSchema"]
  key_links:
    - from: "packages/config/src/env.ts"
      to: "effect"
      via: "Schema.Struct, Schema.optionalWith, Schema.Literal for env var contract"
      pattern: "Schema\\.Struct"
    - from: "packages/config/src/env.ts"
      to: "infrastructure/src/runtime-env.ts"
      via: "Documents the same env vars that _CONFIG.config.allow/prefixes filters"
      pattern: "POSTGRES_HOST|REDIS_HOST|EMAIL_PROVIDER"
---

<objective>
Create the packages/config package containing Effect schemas that define the env var contract between IaC provisioning and runtime packages.

Purpose: Establish a single source of truth for which environment variables exist, their types, defaults, and who produces them (IaC derived, IaC passthrough, secret, runtime-only). This eliminates the implicit contract between infrastructure/src/runtime-env.ts allow-lists and scattered Config.string() calls across packages/server and packages/database.

Output: New packages/config/ package with env.ts (RuntimeEnvSchema composed from sub-schemas) and tenant.ts (TenantConfigSchema for tenant provisioning).
</objective>

<execution_context>
@/Users/bardiasamiee/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bardiasamiee/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-shared-config-schema/03-RESEARCH.md
@infrastructure/src/runtime-env.ts
@infrastructure/src/deploy.ts
@packages/database/src/client.ts
@packages/server/src/infra/email.ts
@packages/server/package.json
@packages/database/package.json
@pnpm-workspace.yaml
@tsconfig.base.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold packages/config package</name>
  <files>packages/config/package.json, packages/config/tsconfig.json, packages/config/vite.config.ts</files>
  <action>
Create a new packages/config/ directory with minimal scaffolding. This package has ONLY effect as a runtime dependency -- zero workspace package imports, zero UI deps. This keeps the infrastructure dependency graph clean (infrastructure already depends on effect).

**package.json:**
```json
{
  "name": "@parametric-portal/config",
  "version": "1.0.0",
  "type": "module",
  "exports": {
    "./env": {
      "types": "./src/env.ts",
      "import": "./src/env.ts",
      "default": "./src/env.ts"
    },
    "./tenant": {
      "types": "./src/tenant.ts",
      "import": "./src/tenant.ts",
      "default": "./src/tenant.ts"
    }
  },
  "scripts": {
    "typecheck": "tsc --project tsconfig.json --noEmit"
  },
  "dependencies": {
    "effect": "catalog:"
  },
  "devDependencies": {
    "@types/node": "catalog:",
    "typescript": "catalog:",
    "vite": "catalog:",
    "vitest": "catalog:"
  }
}
```

**tsconfig.json:** Follow the same pattern as packages/database/tsconfig.json:
```json
{
    "compilerOptions": {
        "composite": false,
        "declaration": false,
        "declarationMap": false,
        "emitDeclarationOnly": false,
        "noEmit": true,
        "outDir": "dist",
        "preserveSymlinks": true,
        "rootDir": ".",
        "types": ["node", "vitest/globals"]
    },
    "exclude": ["dist", "node_modules"],
    "extends": "../../tsconfig.base.json",
    "include": ["src/**/*"],
    "references": []
}
```

**vite.config.ts:** Minimal vite config matching other packages:
```typescript
import { defineConfig } from 'vite';

export default defineConfig({
    build: { lib: { entry: ['src/env.ts', 'src/tenant.ts'], formats: ['es'] }, outDir: 'dist' },
    test: { globals: true },
});
```

After creating these files, run `pnpm install` to register the workspace package.

**[CRITICAL]** The package must NOT import from any other workspace package (`@parametric-portal/*`). It exports schemas and types ONLY. All domain logic stays in its respective package. This prevents circular dependencies (Pitfall 3 from research).
  </action>
  <verify>
Run: `ls packages/config/package.json packages/config/tsconfig.json packages/config/vite.config.ts` -- all three files exist.
Run: `pnpm install` -- succeeds without errors.
Run: `grep '"@parametric-portal/' packages/config/package.json` -- returns zero matches in dependencies (no workspace imports).
Run: `pnpm exec nx run-many -t typecheck` -- passes (may show empty src warning until Task 2 creates source files).
  </verify>
  <done>packages/config package scaffolded with effect-only dependency. Registered in pnpm workspace via packages/* glob. No workspace package imports.</done>
</task>

<task type="auto">
  <name>Task 2: Implement RuntimeEnvSchema and TenantConfigSchema</name>
  <files>packages/config/src/env.ts, packages/config/src/tenant.ts</files>
  <action>
Create the two source files that define the env var contract and tenant config schema.

**packages/config/src/env.ts:**

This file defines composed sub-schemas for every env var consumed by runtime packages. Use the exhaustive env var inventory from 03-RESEARCH.md as the source of truth. Each sub-schema groups related vars. The composed RuntimeEnvSchema is the full contract.

Follow these rules:
- Use `Schema.optionalWith(S.String, { default: () => 'value' })` for vars with defaults
- Use `Schema.optional(S.String)` for truly optional vars (no default, may not be present)
- Use `S.NumberFromString` for numeric env vars (all env vars arrive as strings)
- Use `S.BooleanFromString` for boolean env vars (handles 'true'/'false' strings)
- Use `S.Redacted(S.String)` for secrets (RESEND_API_KEY, POSTGRES_PASSWORD, etc.)
- Annotate each sub-schema with a JSDoc comment listing classification: [IaC-DERIVED], [IaC-PASSTHROUGH], [IaC-SECRET], or [RUNTIME-ONLY]
- Derive types from schemas: `type X = typeof XSchema.Type`

**Sub-schemas to create:**

1. **DeploymentMode** -- `S.Literal('cloud', 'selfhosted')` (used as discriminant)

2. **PostgresEnv** -- All POSTGRES_* vars from client.ts:
   - POSTGRES_HOST (default 'localhost'), POSTGRES_PORT (NumberFromString, default 5432)
   - POSTGRES_SSL (BooleanFromString, default false), POSTGRES_SSL_CA (optional), POSTGRES_SSL_CERT (optional), POSTGRES_SSL_KEY (optional)
   - POSTGRES_SSL_MIN_VERSION (default 'TLSv1.2'), POSTGRES_SSL_REJECT_UNAUTHORIZED (BooleanFromString, default true), POSTGRES_SSL_SERVERNAME (optional)
   - POSTGRES_APP_NAME (default 'parametric-portal'), POSTGRES_POOL_MAX (NumberFromString, default 10), POSTGRES_POOL_MIN (NumberFromString, default 2)
   - POSTGRES_CONNECT_TIMEOUT_MS (NumberFromString, default 5000), POSTGRES_IDLE_TIMEOUT_MS (NumberFromString, default 30000), POSTGRES_CONNECTION_TTL_MS (NumberFromString, default 900000)
   - POSTGRES_STATEMENT_TIMEOUT_MS (NumberFromString, default 30000), POSTGRES_LOCK_TIMEOUT_MS (NumberFromString, default 10000)
   - POSTGRES_IDLE_IN_TXN_TIMEOUT_MS (NumberFromString, default 60000), POSTGRES_TRANSACTION_TIMEOUT_MS (NumberFromString, default 120000)
   - POSTGRES_TRGM_SIMILARITY_THRESHOLD (NumberFromString, default 0.3), POSTGRES_TRGM_WORD_SIMILARITY_THRESHOLD (NumberFromString, default 0.6)
   - POSTGRES_TRGM_STRICT_WORD_SIMILARITY_THRESHOLD (NumberFromString, default 0.5)

3. **RedisEnv** -- All REDIS_* vars from cache.ts:
   - REDIS_HOST (default 'localhost'), REDIS_PORT (NumberFromString, default 6379)
   - REDIS_TLS (BooleanFromString, default false), REDIS_TLS_CA (optional -- Redacted since it's a certificate)
   - REDIS_PASSWORD (optional, Redacted)

4. **StorageEnv** -- All STORAGE_* vars:
   - STORAGE_BUCKET (default 'parametric'), STORAGE_ENDPOINT (optional), STORAGE_REGION (default 'us-east-1')
   - STORAGE_FORCE_PATH_STYLE (BooleanFromString, optional), STORAGE_ACCESS_KEY_ID (Redacted), STORAGE_SECRET_ACCESS_KEY (Redacted)
   - STORAGE_SESSION_TOKEN (optional, Redacted)

5. **EmailEnv** -- All EMAIL_*, RESEND_*, POSTMARK_*, SES_*, SMTP_* vars from email.ts:
   - EMAIL_PROVIDER (Literal 'resend'|'ses'|'postmark'|'smtp', default 'resend')
   - EMAIL_FROM (default 'noreply@parametric.dev'), EMAIL_TIMEOUT_MS (NumberFromString, default 15000)
   - RESEND_API_KEY (optional, Redacted), RESEND_ENDPOINT (default 'https://api.resend.com/emails')
   - POSTMARK_TOKEN (optional, Redacted), POSTMARK_ENDPOINT (default 'https://api.postmarkapp.com/email/withTemplate')
   - SES_REGION (default 'us-east-1'), SES_ENDPOINT (optional)
   - SMTP_HOST (optional), SMTP_PORT (NumberFromString, default 587), SMTP_USER (optional), SMTP_PASS (optional, Redacted)
   - SMTP_SECURE (BooleanFromString, default false), SMTP_REQUIRE_TLS (BooleanFromString, default false)

6. **TelemetryEnv** -- All OTEL_* vars:
   - OTEL_EXPORTER_OTLP_ENDPOINT (optional), OTEL_LOGS_EXPORTER (default 'none')
   - OTEL_METRICS_EXPORTER (default 'otlp'), OTEL_TRACES_EXPORTER (default 'none')

7. **ClusterEnv** -- All CLUSTER_*, K8S_* vars:
   - CLUSTER_HEALTH_MODE (Literal 'k8s'|'ping', default 'ping')
   - K8S_LABEL_SELECTOR (optional), K8S_NAMESPACE (optional)

8. **AppEnv** -- Application-level vars:
   - API_BASE_URL (optional), APP_NAME (default 'Parametric Portal'), CORS_ORIGINS (optional)
   - LOG_LEVEL (optional), NODE_ENV (default 'development'), PORT (NumberFromString, default 4000)
   - PROXY_HOPS (NumberFromString, default 0), TRUST_PROXY (BooleanFromString, default false)

9. **SecretsEnv** -- Cross-cutting secrets not in specific sub-schemas:
   - DATABASE_URL (Redacted), ENCRYPTION_KEY (optional, Redacted), ENCRYPTION_KEYS (optional, Redacted)
   - ANTHROPIC_API_KEY (Redacted), GEMINI_API_KEY (Redacted), OPENAI_API_KEY (Redacted)

10. **OAuthEnv** -- OAuth secrets:
    - OAUTH_APPLE_PRIVATE_KEY (optional, Redacted), OAUTH_GITHUB_CLIENT_SECRET (optional, Redacted)
    - OAUTH_GOOGLE_CLIENT_SECRET (optional, Redacted), OAUTH_MICROSOFT_CLIENT_SECRET (optional, Redacted)

**RuntimeEnvSchema** -- Composed from all sub-schemas using spread of `.fields`:
```typescript
const RuntimeEnvSchema = S.Struct({
    ...PostgresEnv.fields,
    ...RedisEnv.fields,
    ...StorageEnv.fields,
    ...EmailEnv.fields,
    ...TelemetryEnv.fields,
    ...ClusterEnv.fields,
    ...AppEnv.fields,
    ...SecretsEnv.fields,
    ...OAuthEnv.fields,
});
type RuntimeEnv = typeof RuntimeEnvSchema.Type;
```

**[IMPORTANT] Use `S` as the import alias for Schema** -- this is the codebase convention (see email.ts, client.ts). Import as: `import { Schema as S } from 'effect';`

**[IMPORTANT] File organization** follows CLAUDE.md canonical order:
```
// --- [TYPES] -----------------------------------------------------------------
// --- [SCHEMA] ----------------------------------------------------------------
// --- [EXPORT] ----------------------------------------------------------------
```

At the end of the file, export all sub-schemas AND the composed RuntimeEnvSchema via named exports.

**packages/config/src/tenant.ts:**

This file defines the TenantConfigSchema -- the shape of a tenant provisioning request. This is a higher-level schema used by the tenant factory (Phase 5) and TenantLifecycleService (Phase 9).

```typescript
const DeploymentMode = S.Literal('cloud', 'selfhosted');

const TenantConfigSchema = S.Struct({
    domain: S.String,
    mode: DeploymentMode,
    name: S.NonEmptyTrimmedString,
    resources: S.Struct({
        cpuLimit: S.String,
        memoryLimit: S.String,
        replicas: S.NumberFromString.pipe(S.int()),
        storageGi: S.NumberFromString.pipe(S.int()),
    }),
});
type TenantConfig = typeof TenantConfigSchema.Type;
```

Export TenantConfigSchema, TenantConfig, and DeploymentMode.

**[CRITICAL] Do NOT import from any other workspace package.** packages/config depends on effect only.
  </action>
  <verify>
Run: `pnpm exec nx run-many -t typecheck` -- must pass. packages/config must typecheck cleanly.
Run: `grep -c 'S.Struct' packages/config/src/env.ts` -- must return a positive count (sub-schemas are Struct-based).
Run: `grep 'EMAIL_PROVIDER' packages/config/src/env.ts` -- must return a match (email gap var is present).
Run: `grep 'POSTGRES_SSL' packages/config/src/env.ts` -- must return a match (SSL gap var is present).
Run: `grep 'REDIS_TLS_CA' packages/config/src/env.ts` -- must return a match (TLS CA gap var is present).
Run: `grep 'RuntimeEnvSchema' packages/config/src/env.ts` -- must return matches (composed schema exists).
Run: `grep 'TenantConfigSchema' packages/config/src/tenant.ts` -- must return matches.
Run: `grep '@parametric-portal/' packages/config/src/` -- must return zero matches (no workspace imports).
  </verify>
  <done>RuntimeEnvSchema composed from 10 sub-schemas covering all env vars from the gap analysis. TenantConfigSchema defines tenant provisioning contract. All 17 missing vars from research are present. Zero workspace package imports.</done>
</task>

</tasks>

<verification>
1. `ls packages/config/package.json packages/config/src/env.ts packages/config/src/tenant.ts` -- all files exist
2. `pnpm exec nx run-many -t typecheck` -- passes across all workspace packages
3. `grep '@parametric-portal/' packages/config/src/*.ts` -- zero matches (no circular deps)
4. All 17 gap vars from research are present in env.ts: EMAIL_PROVIDER, EMAIL_FROM, EMAIL_TIMEOUT_MS, RESEND_API_KEY, RESEND_ENDPOINT, POSTMARK_TOKEN, POSTMARK_ENDPOINT, SES_REGION, SES_ENDPOINT, SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS, SMTP_SECURE, SMTP_REQUIRE_TLS, POSTGRES_SSL, REDIS_TLS_CA
5. RuntimeEnvSchema is composed from sub-schemas (not a monolithic 200-field flat struct)
6. Types derived from schemas via typeof XSchema.Type (no separate type declarations)
</verification>

<success_criteria>
- packages/config exists as a workspace package with effect-only dependency
- RuntimeEnvSchema composed from 10 sub-schemas documenting the full env var contract
- TenantConfigSchema defines tenant provisioning shape for IaC and runtime
- All 17 missing env vars from gap analysis included in schema
- TypeScript compiles without errors across entire workspace
- Satisfies CONF-01 (shared Effect schema) and CONF-03 (env var contract explicitly defined)
</success_criteria>

<output>
After completion, create `.planning/phases/03-shared-config-schema/03-01-SUMMARY.md`
</output>
