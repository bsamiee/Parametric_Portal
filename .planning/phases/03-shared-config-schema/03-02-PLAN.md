---
phase: 03-shared-config-schema
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - infrastructure/package.json
  - infrastructure/tsconfig.json
  - infrastructure/src/deploy.ts
autonomous: true

must_haves:
  truths:
    - "infrastructure/package.json lists @parametric-portal/config as a workspace dependency"
    - "deploy.ts imports RuntimeEnvSchema from @parametric-portal/config/env and validates the env blob via Schema.decodeUnknownSync before passing to RuntimeEnv.collect"
    - "An invalid env var value (e.g., non-numeric POSTGRES_PORT) causes pulumi preview to fail with a Schema ParseError -- not a silent incorrect value"
    - "Existing deploy behavior is unchanged for valid environments -- the validation is additive, not a replacement of RuntimeEnv.collect"
  artifacts:
    - path: "infrastructure/package.json"
      provides: "Workspace dependency on @parametric-portal/config"
      contains: "@parametric-portal/config"
    - path: "infrastructure/src/deploy.ts"
      provides: "Schema.decodeUnknownSync validation of env vars at IaC boundary"
      contains: "decodeUnknownSync"
  key_links:
    - from: "infrastructure/src/deploy.ts"
      to: "packages/config/src/env.ts"
      via: "import { RuntimeEnvSchema } from '@parametric-portal/config/env'"
      pattern: "@parametric-portal/config/env"
    - from: "infrastructure/src/deploy.ts"
      to: "effect"
      via: "Schema.decodeUnknownSync for IaC-time validation"
      pattern: "Schema\\.decodeUnknownSync"
---

<objective>
Wire infrastructure to import and validate environment variables against the shared schema from packages/config at pulumi preview time.

Purpose: Close the validation gap where IaC passes through env vars as untyped strings without verifying they match the types runtime expects. A non-numeric POSTGRES_PORT or invalid DEPLOYMENT_MODE should fail at `pulumi preview` time, not at container startup. This satisfies CONF-02 (config validation at IaC boundary).

Output: Modified infrastructure/package.json with workspace dep, modified deploy.ts with Schema.decodeUnknownSync validation call.
</objective>

<execution_context>
@/Users/bardiasamiee/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bardiasamiee/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-shared-config-schema/03-RESEARCH.md
@.planning/phases/03-shared-config-schema/03-01-SUMMARY.md
@infrastructure/src/deploy.ts
@infrastructure/src/platform.ts
@infrastructure/package.json
@infrastructure/tsconfig.json
@infrastructure/Pulumi.yaml
@packages/config/src/env.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add @parametric-portal/config dependency to infrastructure</name>
  <files>infrastructure/package.json</files>
  <action>
Add `@parametric-portal/config` as a workspace dependency to infrastructure/package.json.

In the `dependencies` section, add (alphabetically, before `@pulumi/aws`):
```json
"@parametric-portal/config": "workspace:*",
```

Then run `pnpm install` to link the workspace package.

**[IMPORTANT] Pitfall 1 from research:** Pulumi runs TypeScript via its own runtime (not Vite). The packages/config package exports raw .ts source files (same pattern as all other workspace packages -- see packages/server/package.json exports). Since infrastructure already successfully imports effect, and packages/config depends only on effect, the import should resolve. But verify with typecheck after install.

**[IMPORTANT]** Do NOT add @parametric-portal/config to the infrastructure/tsconfig.json references array. The workspace uses `preserveSymlinks: true` and pnpm workspace resolution -- no project references needed (same as how infrastructure already imports effect without references).
  </action>
  <verify>
Run: `grep '@parametric-portal/config' infrastructure/package.json` -- must return the dependency line.
Run: `pnpm install` -- must succeed.
Run: `pnpm exec nx run-many -t typecheck` -- must pass.
  </verify>
  <done>infrastructure package depends on @parametric-portal/config via workspace protocol. pnpm links correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Add Schema.decodeUnknownSync validation to deploy.ts</name>
  <files>infrastructure/src/deploy.ts</files>
  <action>
Add environment variable validation at the IaC boundary in deploy.ts. The validation runs at `pulumi preview` time, before any resources are created. It validates that the env vars match the types the runtime expects.

**Step 1: Add import at the top of deploy.ts**

Add alongside the existing `import { identity, Match } from 'effect';` line:
```typescript
import { Schema as S } from 'effect';
import { RuntimeEnvSchema } from '@parametric-portal/config/env';
```

Note: `effect` is already imported in deploy.ts. The `Schema` import adds the namespace needed for `decodeUnknownSync`. Use `S` as alias per codebase convention.

**Step 2: Add validation call in the deploy function**

In the `deploy` function (near line 251), add validation BEFORE the mode check and _DEPLOY dispatch. The deploy function currently looks like:

```typescript
const deploy = (args: { env: NodeJS.ProcessEnv; stack: string }) => {
    const mode = _Ops.mode(args.env);
    return { ..._DEPLOY[mode](args), mode, stack: args.stack };
};
```

Add a validation step that decodes process.env through the schema. This is additive -- the existing RuntimeEnv.collect logic continues to work as before. The schema validation catches type mismatches EARLY (before resources are created).

Modified deploy function:
```typescript
const deploy = (args: { env: NodeJS.ProcessEnv; stack: string }) => {
    S.decodeUnknownSync(RuntimeEnvSchema, { onExcessProperty: 'ignore' })(args.env);
    const mode = _Ops.mode(args.env);
    return { ..._DEPLOY[mode](args), mode, stack: args.stack };
};
```

**[CRITICAL] Pass `{ onExcessProperty: 'ignore' }` option.** process.env contains hundreds of vars (PATH, HOME, etc.) that are not in the schema. Without this option, Schema.decodeUnknownSync would fail on every unknown key. The `onExcessProperty: 'ignore'` tells the decoder to validate only the fields defined in the schema and ignore everything else.

**[CRITICAL] The validation is additive.** It does NOT replace _Ops.mode, _Ops.text, _Ops.secret, or RuntimeEnv.collect. Those functions continue to provide Pulumi-specific behavior (wrapping secrets with pulumi.secret(), building interpolated strings). The schema validation is a type-safety gate that catches misconfigurations early.

**[IMPORTANT] Error handling:** Schema.decodeUnknownSync throws a ParseError synchronously if validation fails. Since deploy.ts already uses throw (via pulumi.RunError in _Ops.fail), this is consistent. The Pulumi engine will catch the ParseError and display it as a deployment error. The ParseError message is structured and includes which field failed and why.

**[IMPORTANT] Do NOT wrap the decodeUnknownSync in try/catch.** Let it throw directly. Pulumi handles thrown errors during preview/up. Converting to RunError would lose the structured ParseError information.

**What this catches that was previously silent:**
- POSTGRES_PORT='abc' (NumberFromString fails)
- REDIS_TLS='yes' (BooleanFromString expects 'true'/'false')
- DEPLOYMENT_MODE='staging' (Literal expects 'cloud'|'selfhosted')
- EMAIL_PROVIDER='mailgun' (Literal expects 'resend'|'ses'|'postmark'|'smtp')
  </action>
  <verify>
Run: `grep 'RuntimeEnvSchema' infrastructure/src/deploy.ts` -- must return the import and usage.
Run: `grep 'decodeUnknownSync' infrastructure/src/deploy.ts` -- must return exactly 1 match (the validation call).
Run: `grep '@parametric-portal/config/env' infrastructure/src/deploy.ts` -- must return exactly 1 match (the import).
Run: `grep "onExcessProperty: 'ignore'" infrastructure/src/deploy.ts` -- must return 1 match (excess property handling).
Run: `pnpm exec nx run-many -t typecheck` -- must pass across all workspace packages.
  </verify>
  <done>deploy.ts validates env vars through RuntimeEnvSchema at IaC boundary. Invalid config fails at pulumi preview time with structured ParseError. Existing deploy behavior unchanged for valid environments.</done>
</task>

</tasks>

<verification>
1. `grep '@parametric-portal/config' infrastructure/package.json` -- workspace dependency exists
2. `grep 'RuntimeEnvSchema' infrastructure/src/deploy.ts` -- imported and used
3. `grep 'decodeUnknownSync' infrastructure/src/deploy.ts` -- validation call exists
4. `grep "onExcessProperty: 'ignore'" infrastructure/src/deploy.ts` -- excess property handling present
5. `pnpm exec nx run-many -t typecheck` -- passes across entire workspace
6. The deploy function validates env BEFORE creating resources -- validation is first line of deploy()
</verification>

<success_criteria>
- infrastructure depends on @parametric-portal/config via workspace protocol
- Schema.decodeUnknownSync validates env vars at IaC boundary before resource creation
- Invalid env var types fail at pulumi preview time with structured ParseError
- Existing deploy behavior unchanged for valid environments
- TypeScript compiles without errors across entire workspace
- Satisfies CONF-02 (config validation at IaC boundary -- external config decoded as unknown and validated through schema)
</success_criteria>

<output>
After completion, create `.planning/phases/03-shared-config-schema/03-02-SUMMARY.md`
</output>
