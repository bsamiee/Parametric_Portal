---
phase: 04-job-processing
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - packages/server/src/observe/metrics.ts
autonomous: true

must_haves:
  truths:
    - "MetricsService.jobs includes dlqSize gauge"
    - "MetricsService.jobs includes processingSeconds histogram"
    - "All job.* metrics from success criteria are present"
  artifacts:
    - path: "packages/server/src/observe/metrics.ts"
      provides: "Extended jobs metrics namespace"
      contains: "dlqSize"
  key_links:
    - from: "packages/server/src/observe/metrics.ts"
      to: "packages/server/src/infra/jobs.ts"
      via: "metrics consumed by JobService"
      pattern: "jobs_dlq_size"
---

<objective>
Extend MetricsService with job.* metrics for Entity-based job processing.

Purpose: Success criteria #12 requires specific metrics. Extend existing jobs namespace with dlqSize and processingSeconds.
Output: MetricsService.jobs extended with Phase 4 metrics
</objective>

<execution_context>
@/Users/bardiasamiee/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bardiasamiee/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-job-processing/04-RESEARCH.md
@packages/server/src/observe/metrics.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend jobs namespace with Phase 4 metrics</name>
  <files>packages/server/src/observe/metrics.ts</files>
  <action>
Extend the existing `jobs` object in MetricsService.effect with additional metrics.

Current jobs metrics (keep all):
- completions, deadLettered, duration, enqueued, failures, queueDepth, retries, waitDuration

Add new metrics for Phase 4:
- `dlqSize`: Metric.gauge('jobs_dlq_size') - Current DLQ depth
- `processingSeconds`: Metric.timerWithBoundaries('jobs_processing_seconds', _boundaries.jobs) - Job execution time (distinct from duration which includes queue wait)
- `cancellations`: Metric.counter('jobs_cancelled_total') - Cancelled jobs

The full jobs object should be:
```typescript
jobs: {
  cancellations: Metric.counter('jobs_cancelled_total'),
  completions: Metric.counter('jobs_completed_total'),
  deadLettered: Metric.counter('jobs_dead_lettered_total'),
  dlqSize: Metric.gauge('jobs_dlq_size'),
  duration: Metric.timerWithBoundaries('jobs_duration_seconds', _boundaries.jobs),
  enqueued: Metric.counter('jobs_enqueued_total'),
  failures: Metric.counter('jobs_failed_total'),
  processingSeconds: Metric.timerWithBoundaries('jobs_processing_seconds', _boundaries.jobs),
  queueDepth: Metric.gauge('jobs_queue_depth'),
  retries: Metric.counter('jobs_retried_total'),
  waitDuration: Metric.timerWithBoundaries('jobs_wait_duration_seconds', _boundaries.jobs),
},
```

Keep alphabetical ordering as in existing code.
  </action>
  <verify>`pnpm exec nx run server:typecheck` passes</verify>
  <done>MetricsService.jobs includes dlqSize, processingSeconds, cancellations</done>
</task>

<task type="auto">
  <name>Task 2: Verify metrics match success criteria</name>
  <files>packages/server/src/observe/metrics.ts</files>
  <action>
Verify that all metrics from Phase 4 success criteria #12 are present:
- job.queue_depth -> jobs_queue_depth (existing queueDepth)
- job.processing_seconds -> jobs_processing_seconds (new processingSeconds)
- job.failures_total -> jobs_failed_total (existing failures)
- job.dlq_size -> jobs_dlq_size (new dlqSize)

Also verify existing metrics support the job patterns:
- jobs_enqueued_total with labels: type, priority (existing enqueued)
- jobs_completed_total with labels: type (existing completions)
- jobs_dead_lettered_total with labels: type (existing deadLettered)

No additional code changes needed if Task 1 is complete - this task verifies the mapping.
  </action>
  <verify>All required metrics present in jobs namespace</verify>
  <done>Metrics match Phase 4 success criteria requirements</done>
</task>

</tasks>

<verification>
1. `pnpm exec nx run server:typecheck` - Type checking passes
2. MetricsService.jobs.dlqSize exists as Metric.Gauge
3. MetricsService.jobs.processingSeconds exists as timer with boundaries
4. MetricsService.jobs.cancellations exists as counter
5. All success criteria #12 metrics mapped
</verification>

<success_criteria>
- dlqSize gauge tracks DLQ depth
- processingSeconds histogram tracks execution time separately from queue wait
- cancellations counter tracks interrupted jobs
- Existing metrics unchanged
- Alphabetical ordering maintained
</success_criteria>

<output>
After completion, create `.planning/phases/04-job-processing/04-03-SUMMARY.md`
</output>
