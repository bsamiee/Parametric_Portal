name: Node Environment
description: Node.js + pnpm setup with caching and Nx monorepo support
inputs:
    node-version:
        description: Node.js version (ignored if node-version-file is set)
        default: '25.2.1'
    node-version-file:
        description: File containing Node.js version (e.g., package.json)
        required: false
    pnpm-version:
        description: pnpm version
        default: '10.24.0'
    install:
        description: Run pnpm install
        default: 'true'
    frozen-lockfile:
        description: Use --frozen-lockfile flag
        default: 'true'
    nx:
        description: Enable Nx caching and affected setup
        default: 'false'
    nx-main-branch:
        description: Main branch for affected comparison
        default: 'main'

outputs:
    nx-base:
        description: Base SHA for Nx affected commands
        value: ${{ steps.shas.outputs.base }}
    nx-head:
        description: Head SHA for Nx affected commands
        value: ${{ steps.shas.outputs.head }}

runs:
    using: composite
    steps:
        - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
          with:
              version: ${{ inputs.pnpm-version }}

        - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
          with:
              node-version: ${{ inputs.node-version-file && '' || inputs.node-version }}
              node-version-file: ${{ inputs.node-version-file }}
              cache: ${{ inputs.install == 'true' && 'pnpm' || '' }}

        - name: Install dependencies
          if: inputs.install == 'true'
          shell: bash
          run: pnpm install ${{ inputs.frozen-lockfile == 'true' && '--frozen-lockfile' || '' }}

        - name: Restore Nx cache
          if: inputs.nx == 'true'
          uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
          with:
              path: .nx/cache
              key: ${{ runner.os }}-nx-${{ hashFiles('pnpm-lock.yaml') }}-${{ github.sha }}
              restore-keys: |
                  ${{ runner.os }}-nx-${{ hashFiles('pnpm-lock.yaml') }}-
                  ${{ runner.os }}-nx-

        - name: Set affected SHAs
          id: shas
          if: inputs.nx == 'true'
          uses: nrwl/nx-set-shas@3e9ad7370203c1e93d109be57f3b72eb0eb511b1 # v4.4.0
          with:
              main-branch-name: ${{ inputs.nx-main-branch }}
