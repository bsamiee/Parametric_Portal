name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review (manual trigger)'
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read
  id-token: write

concurrency:
  group: claude-review-${{ github.event.pull_request.number || github.event.inputs.pr_number }}
  cancel-in-progress: true

jobs:
  claude-review:
    # Skip draft PRs (will run on ready_for_review), skip if title starts with WIP
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (github.event.pull_request.draft != true && !startsWith(github.event.pull_request.title, 'WIP'))
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          settings: ".claude/settings.json"
          additional_permissions: |
            actions: read
          claude_args: >-
            --model claude-opus-4-5-20251101
            --allowedTools
            "Read,Write,Edit,Glob,Grep,Task,TodoWrite,Skill,WebSearch,WebFetch,
            Bash(gh:*),Bash(git:*),Bash(pnpm:*),Bash(node:*),Bash(uv:*),
            mcp__github__create_pending_pull_request_review,
            mcp__github__get_pull_request_diff,
            mcp__github__add_comment_to_pending_review,
            mcp__github__submit_pending_pull_request_review"
          prompt: |
            [REQUIRED]: Create a single OVERVIEW comment, NEST all findings/suggestions/fixes underneath this comment as individual comments, with proper formatting for PR reviews.

            [CONTEXT]
            Repository: ${{ github.repository }}
            PR Number: ${{ github.event.pull_request.number || github.event.inputs.pr_number }}
            Base: ${{ github.base_ref || 'main' }}
            Head: ${{ github.head_ref || github.ref_name }}
            Trigger: ${{ github.event_name }}.${{ github.event.action || 'dispatch' }}

            [PHASE_1] Load Standards
            1. Read CLAUDE.md — agent behavior, philosophy, constraints
            2. Read REQUIREMENTS.md — technical specification, code standards
            3. Read .claude/skills/style-standards/SKILL.md — formatting rules
            4. Read .claude/skills/typescript-effect/SKILL.md — TypeScript patterns
            5. Read .claude/skills/parallel-dispatch/SKILL.md - parallel dispatching rules

            [PHASE_2] Get Changes
            1. gh pr diff ${{ github.event.pull_request.number || github.event.inputs.pr_number }} --name-only
            2. gh pr diff ${{ github.event.pull_request.number || github.event.inputs.pr_number }}
            3. Read each changed file for full context

            [PHASE_3] Analysis
            - >5 files: Use parallel-dispatch skill — each agent reviews assigned files + relevant context
            - ≤5 files: Analyze sequentially
            - Context per file: imports/dependencies, sibling files in folder, root configs (tsconfig, vite, nx)
            - CI status: gh pr checks ${{ github.event.pull_request.number || github.event.inputs.pr_number }} — if failures, gh run view <run-id> --log-failed
            - Apply standards; flag violations, anti-patterns, improvements
            - Reject band-aids — require proper solutions

            [PHASE_4] Output
            Use the pending review workflow for inline comments:
            1. mcp__github__create_pending_pull_request_review — start pending review
            2. mcp__github__get_pull_request_diff — get line numbers for targeting
            3. mcp__github__add_comment_to_pending_review — add each inline comment
            4. mcp__github__submit_pending_pull_request_review — submit with event "COMMENT"

            [COMMENT_FORMAT]
            **Issue:** Concise problem statement
            > Rationale and how the fix addresses it

            ```suggestion
            complete replacement code
            ```

            [CONSTRAINTS]
            - One ```suggestion block per comment — triggers GitHub's "Commit suggestion" button
            - Suggestion must contain COMPLETE replacement code for the line(s)
