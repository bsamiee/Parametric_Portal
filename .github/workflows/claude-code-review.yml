name: Claude Code Review

on:
    issue_comment:
        types: [created]
    pull_request_review_comment:
        types: [created]

concurrency:
    group: claude-review-${{ github.event.issue.number || github.event.pull_request.number }}
    cancel-in-progress: true

permissions:
    contents: read
    pull-requests: write
    issues: read
    id-token: write

jobs:
    # --- On-Demand Code Review (triggered by @claude mention) -------------------
    claude-review:
        if: |
            (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
            (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude'))
        runs-on: ubuntu-latest
        timeout-minutes: 15

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Claude Code Review
              uses: anthropics/claude-code-action@v1
              with:
                  claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
                  additional_permissions: |
                      actions: read
                  # No prompt - let Claude respond to the @claude mention interactively
                  claude_args: >-
                      --model claude-sonnet-4-5-20250929
                      --max-turns 10
                      --allowed-tools Read,Grep,Glob,Bash(gh pr diff *),Bash(gh pr view *),Bash(gh pr review *),Bash(gh api *),Bash(cat *),Bash(rm *)
