name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      actions: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          use_sticky_comment: true
          track_progress: true
          settings: ".claude/settings.json"
          additional_permissions: |
            actions: read
          claude_args: >-
            --model claude-opus-4-5-20251101
            --allowedTools
            "Read,Write,Edit,Glob,Grep,Task,TodoWrite,WebFetch,
            Bash(gh pr diff:*),
            Bash(gh pr view:*),
            Bash(gh pr comment:*),
            Bash(gh pr files:*),
            Bash(git diff:*),
            Bash(git log:*),
            mcp__github_inline_comment__create_inline_comment"
          prompt: |
            [CONTEXT]
            Repository: ${{ github.repository }} | PR: ${{ github.event.pull_request.number }}
            Base: ${{ github.base_ref }} | Head: ${{ github.head_ref }}

            [PHASE_1] Load Standards
            1. Read CLAUDE.md — agent behavior, philosophy, constraints
            2. Read REQUIREMENTS.md — technical specification, code standards
            3. Read .claude/skills/style-standards/SKILL.md — formatting rules
            4. Read .claude/skills/typescript-effect/SKILL.md — TypeScript patterns

            [PHASE_2] Get Changes
            1. gh pr diff ${{ github.event.pull_request.number }} --name-only
            2. gh pr diff ${{ github.event.pull_request.number }}
            3. Read each changed file for full context

            [PHASE_3] Analysis
            - >5 files: Use Task tool to spawn parallel agents (3-5 files per batch)
            - ≤5 files: Analyze sequentially
            - Apply loaded standards; identify code smells, anti-patterns, improvements
            - Reject workarounds/band-aids — find proper solutions

            [PHASE_4] Output
            For each issue: mcp__github_inline_comment__create_inline_comment

            [COMMENT_FORMAT]
            **Issue:** Concise problem statement
            > Rationale and how the fix addresses it

            ```suggestion
            complete replacement code
            ```

            [CONSTRAINTS]
            - One ```suggestion block per comment — triggers GitHub's "Commit suggestion" button
            - Suggestion must contain COMPLETE replacement code for the line(s)