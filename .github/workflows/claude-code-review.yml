name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # Removed path filters - now runs on all PRs like Gemini and Copilot

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  claude-review:
    # Only run on non-fork PRs (same pattern as Gemini)
    if: github.event.pull_request.head.repo.fork == false
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          fetch-depth: 0

      - name: Setup .NET 8
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
        with:
          dotnet-version: '8.0.x'

      - name: Create review output directory
        run: mkdir -p .github/review-output

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@f0c8eb29807907de7f5412d04afceb5e24817127 # v1.0.23
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Review PR #${{ github.event.pull_request.number }} against CLAUDE.md standards.

            ## OUTPUT REQUIREMENT

            You MUST generate structured JSON output to `.github/review-output/pr-${{ github.event.pull_request.number }}.json`.

            The JSON must follow this schema:
            ```json
            {
              "pr_number": ${{ github.event.pull_request.number }},
              "verdict": "approve" | "request_changes",
              "violations": [
                {
                  "rule": "RULE_ID",
                  "file": "relative/path.cs",
                  "start_line": 1,
                  "end_line": 1,
                  "current": "code that violates",
                  "suggested": "code that fixes",
                  "severity": "error",
                  "context": "optional explanation"
                }
              ],
              "passed_checks": ["RULE_ID", ...],
              "metadata": {
                "review_timestamp": "ISO 8601 timestamp",
                "build_status": "success" | "failure"
              }
            }
            ```

            Valid RULE_IDs: NO_VAR, NO_IF_ELSE, TRAILING_COMMA, NAMED_PARAMETERS,
            TARGET_TYPED_NEW, COLLECTION_EXPRESSIONS, FILE_SCOPED_NAMESPACE,
            ONE_TYPE_PER_FILE, KR_BRACE_STYLE, PATTERN_MATCHING, RESULT_MONAD,
            UNIFIED_OPERATION, ERROR_REGISTRY, FILES_PER_FOLDER, TYPES_PER_FOLDER,
            LOC_PER_MEMBER, PRIMARY_CONSTRUCTORS

            ## MANDATORY CHECKS (build failures)

            **Syntax violations** (search for these patterns):
            - `var ` declarations → must use explicit types (NO_VAR)
            - `if (` with `} else {` → must use ternary/switch expressions (NO_IF_ELSE)
            - `new List<` or `new Dictionary<` → must use collection expressions `[]` (COLLECTION_EXPRESSIONS)
            - Missing trailing commas in multi-line arrays/collections (TRAILING_COMMA)
            - `namespace X {` → must use file-scoped `namespace X;` (FILE_SCOPED_NAMESPACE)

            **Architecture violations**:
            - Direct `throw new` → must return `Result<T>` with `E.*` errors (RESULT_MONAD)
            - Missing named parameters for non-obvious args (NAMED_PARAMETERS)
            - Multiple types in single file (ONE_TYPE_PER_FILE)
            - Helper method extraction instead of inline logic

            **Organization violations**:
            - Method >300 LOC (LOC_PER_MEMBER)
            - >4 files per folder (FILES_PER_FOLDER)
            - >10 types per folder (TYPES_PER_FOLDER)

            ## EXECUTION STEPS

            1. Run `dotnet build` to check analyzer compliance
            2. Search changed files for pattern violations
            3. For each violation found, record with exact line numbers and suggested fix
            4. Write JSON to `.github/review-output/pr-${{ github.event.pull_request.number }}.json`
            5. Use `gh pr review` with `--approve` or `--request-changes` based on verdict

            ## IMPORTANT

            - The JSON file MUST be created even if verdict is "approve" (with empty violations array)
            - Include ALL passed checks in passed_checks array
            - Violations must have actionable suggested fixes
            - Apply fixes in reverse line order (highest line first) within each file to prevent shifts

          claude_args: |
            --model claude-opus-4-5-20251101
            --max-turns 8
            --allowedTools Read,Write,Grep,Glob,Bash(dotnet:*),Bash(git diff:*),Bash(gh pr:*)

      - name: Save PR metadata for downstream workflows
        if: always()
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HEAD_BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          echo "$PR_NUMBER" > .github/review-output/pr-number.txt
          echo "$HEAD_BRANCH" > .github/review-output/head-branch.txt

      - name: Upload review output
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: review-output
          path: .github/review-output/
          if-no-files-found: warn
          retention-days: 30
