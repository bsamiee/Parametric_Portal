name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      actions: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@7145c3e0510bcdbdd29f67cc4a8c1958f1acfa2f # v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          settings: ".claude/settings.json"
          additional_permissions: |
            actions: read
          claude_args: >-
            --model claude-opus-4-5-20251101
            --allowedTools
            "Read,Write,Edit,Glob,Grep,Task,TodoWrite,Skill,WebSearch,WebFetch,
            Bash(gh:*),Bash(git:*),Bash(pnpm:*),Bash(node:*),Bash(uv:*)"
          prompt: |
            [REQUIRED]: Create a single OVERVIEW comment, NEST all findings/suggestions/fixes underneath this comment as individual comments, with proper formatting for PR reviews.

            [CONTEXT]
            Repository: ${{ github.repository }} | PR: ${{ github.event.pull_request.number }}
            Base: ${{ github.base_ref }} | Head: ${{ github.head_ref }}

            [PHASE_1] Load Standards
            1. Read CLAUDE.md — agent behavior, philosophy, constraints
            2. Read REQUIREMENTS.md — technical specification, code standards
            3. Read .claude/skills/style-standards/SKILL.md — formatting rules
            4. Read .claude/skills/typescript-effect/SKILL.md — TypeScript patterns
            5. Read .claude/skills/parallel-dispatch/SKILL.md - parallel dispatching rules

            [PHASE_2] Get Changes
            1. gh pr diff ${{ github.event.pull_request.number }} --name-only
            2. gh pr diff ${{ github.event.pull_request.number }}
            3. Read each changed file for full context

            [PHASE_3] Analysis
            - >5 files: Use parallel-dispatch skill — each agent reviews assigned files + relevant context
            - ≤5 files: Analyze sequentially
            - Context per file: imports/dependencies, sibling files in folder, root configs (tsconfig, vite, nx)
            - CI status: gh pr checks ${{ github.event.pull_request.number }} — if failures, gh run view <run-id> --log-failed
            - Apply standards; flag violations, anti-patterns, improvements
            - Reject band-aids — require proper solutions

            [PHASE_4] Output
            Collect all issues, then submit ONE review via gh api:
            gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews \
              --method POST -f body="SUMMARY" -f event="COMMENT" \
              -f comments='[{"path":"file","line":N,"body":"COMMENT"}]'

            [COMMENT_FORMAT]
            **Issue:** Concise problem statement
            > Rationale and how the fix addresses it

            ```suggestion
            complete replacement code
            ```

            [CONSTRAINTS]
            - One ```suggestion block per comment — triggers GitHub's "Commit suggestion" button
            - Suggestion must contain COMPLETE replacement code for the line(s)
