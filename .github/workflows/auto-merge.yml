name: Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: auto-merge-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  # --- Bot Auto-Merge (Unified) ---------------------------------------------
  bot-merge:
    name: Bot Auto-Merge
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]' || github.actor == 'renovate[bot]'
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          sparse-checkout: |
            .github/scripts
            .github/actions
            package.json
            pnpm-workspace.yaml
            pnpm-lock.yaml

      - uses: ./.github/actions/node-env
        with:
          node-version-file: package.json

      - uses: lewagon/wait-on-check-action@3603e826ee561ea102b58accb5ea55a1a7482343 # v1.4.1
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          check-name: 'Code Quality'
          wait-interval: 30
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          allowed-conclusions: success,skipped

      - uses: lewagon/wait-on-check-action@3603e826ee561ea102b58accb5ea55a1a7482343 # v1.4.1
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          check-name: 'Security Summary'
          wait-interval: 30
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          allowed-conclusions: success,skipped

      - name: Auto-Merge Decision
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        env:
          NODE_OPTIONS: --import tsx
        with:
          script: |
            const { run } = await import('${{ github.workspace }}/.github/scripts/auto-merge.ts');
            const labels = context.payload.pull_request.labels.map(l => l.name);
            await run({
              context: { repo: context.repo, payload: { action: context.payload.action, issue: {} } },
              core,
              github,
              spec: {
                prNumber: context.payload.pull_request.number,
                actor: '${{ github.actor }}',
                sha: context.payload.pull_request.head.sha,
                labels,
                title: context.payload.pull_request.title
              }
            });

