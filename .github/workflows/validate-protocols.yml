name: Validate Protocols

on:
    pull_request:
        types: [opened, edited, synchronize]
        paths:
            - '*.md'
            - '.github/**/*.md'
            - 'tools/sync-agent-protocols.ts'

permissions:
    contents: read
    pull-requests: write

concurrency:
    group: validate-protocols-${{ github.event.pull_request.number }}
    cancel-in-progress: true

jobs:
    validate:
        name: Protocol Drift Detection
        runs-on: ubuntu-latest
        timeout-minutes: 5

        steps:
            - name: Checkout
              uses: actions/checkout@c2d88d3ecc89a9ef08eebf45d9637801dcee7eb5 # v6

            - name: Setup Environment
              uses: ./.github/actions/setup

            - name: Validate Protocol Synchronization
              id: validate
              run: |
                  echo "### Protocol Drift Detection" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  
                  if pnpm sync:protocols --dry-run 2>&1 | tee validation.log; then
                    echo "status=synchronized" >> $GITHUB_OUTPUT
                    echo "[OK] All protocol files are synchronized with REQUIREMENTS.md" >> $GITHUB_STEP_SUMMARY
                    exit 0
                  else
                    echo "status=drift" >> $GITHUB_OUTPUT
                    echo "[ERROR] Protocol drift detected!" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "**Action Required:** Run \`pnpm sync:protocols\` locally and commit the changes." >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                    cat validation.log >> $GITHUB_STEP_SUMMARY
                    echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                    exit 1
                  fi

            - name: Comment on PR (if drift detected)
              if: failure() && steps.validate.outputs.status == 'drift'
              uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
              with:
                  script: |
                      const fs = require('fs');
                      const log = fs.existsSync('validation.log') 
                        ? fs.readFileSync('validation.log', 'utf8')
                        : 'Validation log not found';
                      
                      await github.rest.issues.createComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: context.issue.number,
                        body: `## [ERROR] Protocol Drift Detected
                      
                      Protocol files are out of sync with \`REQUIREMENTS.md\`.
                      
                      **Fix:**
                      \`\`\`bash
                      pnpm sync:protocols
                      git add AGENTS.md CLAUDE.md .github/copilot-instructions.md
                      git commit -m "chore: sync protocol files with REQUIREMENTS.md"
                      \`\`\`
                      
                      <details>
                      <summary>Validation Output</summary>
                      
                      \`\`\`
                      ${log}
                      \`\`\`
                      </details>`
                      });
