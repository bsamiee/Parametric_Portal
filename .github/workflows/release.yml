name: Release

on:
    push:
        branches: [main]
        paths:
            - 'packages/**'
            - 'apps/**'
            - 'package.json'
    workflow_dispatch:
        inputs:
            release_type:
                description: 'Release type'
                required: true
                type: choice
                options:
                    - auto
                    - major
                    - minor
                    - patch

permissions:
    contents: write
    pull-requests: read

concurrency:
    group: release
    cancel-in-progress: false

jobs:
    release:
        name: Create Release
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@c2d88d3ecc89a9ef08eebf45d9637801dcee7eb5 # v6
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Environment
              uses: ./.github/actions/setup

            - name: Analyze Commits
              id: analyze
              uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
              with:
                  script: |
                      const { analyze } = await import('${{ github.workspace }}/.github/scripts/release.ts');
                      return await analyze(
                        { context: { repo: context.repo, payload: context.payload }, core, github },
                        '${{ github.event.inputs.release_type }}' || 'auto'
                      );

            - name: Calculate New Version
              id: version
              run: |
                  current_version=$(node -p "require('./package.json').version")
                  bump_type="${{ fromJSON(steps.analyze.outputs.result).bump }}"
                  
                  IFS='.' read -r major minor patch <<< "$current_version"
                  
                  case "$bump_type" in
                    major)
                      major=$((major + 1))
                      minor=0
                      patch=0
                      ;;
                    minor)
                      minor=$((minor + 1))
                      patch=0
                      ;;
                    patch)
                      patch=$((patch + 1))
                      ;;
                  esac
                  
                  new_version="${major}.${minor}.${patch}"
                  echo "new_version=${new_version}" >> $GITHUB_OUTPUT
                  echo "tag=v${new_version}" >> $GITHUB_OUTPUT

            - name: Update Package Version
              if: fromJSON(steps.analyze.outputs.result).hasChanges
              run: |
                  npm version ${{ steps.version.outputs.new_version }} --no-git-tag-version
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add package.json
                  git commit -m "chore(release): ${{ steps.version.outputs.tag }}"
                  git push

            - name: Create Git Tag
              if: fromJSON(steps.analyze.outputs.result).hasChanges
              run: |
                  git tag ${{ steps.version.outputs.tag }}
                  git push origin ${{ steps.version.outputs.tag }}

            - name: Create GitHub Release
              if: fromJSON(steps.analyze.outputs.result).hasChanges
              uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
              with:
                  script: |
                      const { create } = await import('${{ github.workspace }}/.github/scripts/release.ts');
                      const analysis = ${{ steps.analyze.outputs.result }};
                      await create(
                        { context: { repo: context.repo, payload: context.payload }, core, github },
                        '${{ steps.version.outputs.tag }}',
                        analysis.changelog
                      );
