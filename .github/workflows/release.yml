name: Release

on:
    push:
        branches: [main]
        paths:
            - 'packages/**'
            - 'apps/**'
            - 'package.json'
    workflow_dispatch:
        inputs:
            release_type:
                description: 'Release type (auto uses conventional commits)'
                required: true
                type: choice
                options:
                    - auto
                    - major
                    - minor
                    - patch
            dry_run:
                description: 'Dry run (preview without changes)'
                required: false
                type: boolean
                default: false

permissions:
    contents: write
    pull-requests: read
    id-token: write

concurrency:
    group: release
    cancel-in-progress: false

env:
    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

jobs:
    release:
        name: Create Release
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v6
              with:
                  fetch-depth: 0
                  filter: tree:0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Environment
              uses: ./.github/actions/node-env

            - name: Setup Nx
              uses: ./.github/actions/nx-setup

            - name: Setup Git Identity
              uses: ./.github/actions/git-identity

            - name: Determine Release Arguments
              id: args
              run: |
                  RELEASE_TYPE="${{ github.event.inputs.release_type || 'auto' }}"
                  DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"

                  # Build nx release arguments
                  ARGS="--skip-publish"

                  if [ "$DRY_RUN" = "true" ]; then
                    ARGS="$ARGS --dry-run"
                  fi

                  # For manual version bumps, specify the version type
                  if [ "$RELEASE_TYPE" != "auto" ]; then
                    ARGS="$ARGS --specifier=$RELEASE_TYPE"
                  fi

                  echo "args=$ARGS" >> $GITHUB_OUTPUT
                  echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
                  echo "dry_run=$DRY_RUN" >> $GITHUB_OUTPUT

            - name: Preview Release (Dry Run)
              if: github.event.inputs.dry_run == 'true'
              run: |
                  echo "## Release Preview" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  pnpm exec nx release ${{ steps.args.outputs.args }} --verbose 2>&1 | tee release-preview.txt || true
                  echo '```' >> $GITHUB_STEP_SUMMARY
                  cat release-preview.txt >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY

            - name: Execute Release
              if: github.event.inputs.dry_run != 'true'
              id: release
              run: |
                  # Run nx release with configured settings from nx.json
                  # This will:
                  # 1. Analyze conventional commits (if auto)
                  # 2. Determine version bump
                  # 3. Update package.json versions
                  # 4. Generate CHANGELOG.md
                  # 5. Create git commit and tag
                  # 6. Create GitHub release (via createRelease: "github" in nx.json)
                  pnpm exec nx release ${{ steps.args.outputs.args }} --yes

            - name: Job Summary
              if: always() && github.event.inputs.dry_run != 'true'
              run: |
                  echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "- **Release Type**: ${{ steps.args.outputs.release_type }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Version**: $(node -p \"require('./package.json').version\")" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Recent Tags" >> $GITHUB_STEP_SUMMARY
                  git tag --sort=-creatordate | head -5 | while read tag; do echo "- $tag"; done >> $GITHUB_STEP_SUMMARY
