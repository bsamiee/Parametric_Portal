name: Bundle Analysis

on:
    pull_request:
        types: [opened, synchronize]
        paths:
            - 'packages/**'
            - 'apps/**'
            - 'vite.config.ts'
            - 'package.json'
            - 'pnpm-lock.yaml'

permissions:
    contents: read
    pull-requests: write

concurrency:
    group: bundle-${{ github.event.pull_request.number }}
    cancel-in-progress: true

jobs:
    analyze:
        name: Analyze Bundle Size
        runs-on: ubuntu-latest
        steps:
            - name: Checkout PR
              uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

            - name: Setup Environment
              uses: ./.github/actions/node-env

            - name: Build Packages
              run: pnpm exec nx run-many -t build --parallel=4

            - name: Analyze Bundle Sizes (PR)
              run: tsx .github/scripts/bundle-sizes.ts > pr-sizes.json

            - name: Checkout Base Branch
              uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
              with:
                  ref: ${{ github.event.pull_request.base.ref }}
                  path: base

            - name: Setup Base Branch
              working-directory: base
              run: |
                  pnpm install --frozen-lockfile
                  pnpm exec nx run-many -t build --parallel=4

            - name: Analyze Bundle Sizes (Base)
              working-directory: base
              run: tsx ../.github/scripts/bundle-sizes.ts > ../base-sizes.json

            - name: Post Bundle Report
              uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
              with:
                  script: |
                      const fs = require('fs');
                      const { run } = await import('${{ github.workspace }}/.github/scripts/report.ts');
                      await run({
                        context: { repo: context.repo, payload: { action: 'opened', issue: {} } },
                        core,
                        github,
                        spec: {
                          kind: 'bundle',
                          pr: JSON.parse(fs.readFileSync('pr-sizes.json', 'utf8')),
                          base: JSON.parse(fs.readFileSync('base-sizes.json', 'utf8')),
                          n: context.payload.pull_request.number
                        }
                      });
