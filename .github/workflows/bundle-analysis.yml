name: Bundle Analysis

on:
    pull_request:
        types: [opened, synchronize]
        paths:
            - 'packages/**'
            - 'apps/**'
            - 'vite.config.ts'
            - 'package.json'
            - 'pnpm-lock.yaml'

permissions:
    contents: read
    pull-requests: write

concurrency:
    group: bundle-${{ github.event.pull_request.number }}
    cancel-in-progress: true

jobs:
    analyze:
        name: Analyze Bundle Size
        runs-on: ubuntu-latest
        steps:
            - name: Checkout PR
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v6

            - name: Setup Environment
              uses: ./.github/actions/node-env

            - name: Build Packages
              run: pnpm exec nx run-many -t build --parallel=4

            - name: Analyze Bundle Sizes (PR)
              id: analyze-pr
              run: |
                  echo "Analyzing PR bundle sizes..."
                  sizes_json='{"packages":[]}'

                  for pkg in packages/*/dist; do
                    if [ -d "$pkg" ]; then
                      pkg_name=$(basename $(dirname "$pkg"))

                      # Calculate sizes
                      raw_size=$(du -sb "$pkg" | cut -f1)

                      # Find main entry
                      main_file=$(find "$pkg" -name "*.js" -type f | head -1)
                      if [ -n "$main_file" ]; then
                        gzip_size=$(gzip -c "$main_file" | wc -c)
                        brotli_size=$(brotli -c "$main_file" | wc -c)
                      else
                        gzip_size=0
                        brotli_size=0
                      fi

                      sizes_json=$(echo "$sizes_json" | jq --arg name "$pkg_name" \
                        --argjson raw "$raw_size" \
                        --argjson gzip "$gzip_size" \
                        --argjson brotli "$brotli_size" \
                        '.packages += [{name: $name, raw: $raw, gzip: $gzip, brotli: $brotli}]')
                    fi
                  done

                  echo "$sizes_json" > pr-sizes.json
                  cat pr-sizes.json

            - name: Checkout Base Branch
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v6
              with:
                  ref: ${{ github.event.pull_request.base.ref }}
                  path: base

            - name: Setup Base Branch
              working-directory: base
              run: |
                  pnpm install --frozen-lockfile
                  pnpm exec nx run-many -t build --parallel=4

            - name: Analyze Bundle Sizes (Base)
              id: analyze-base
              working-directory: base
              run: |
                  echo "Analyzing base bundle sizes..."
                  sizes_json='{"packages":[]}'

                  for pkg in packages/*/dist; do
                    if [ -d "$pkg" ]; then
                      pkg_name=$(basename $(dirname "$pkg"))

                      raw_size=$(du -sb "$pkg" | cut -f1)

                      main_file=$(find "$pkg" -name "*.js" -type f | head -1)
                      if [ -n "$main_file" ]; then
                        gzip_size=$(gzip -c "$main_file" | wc -c)
                        brotli_size=$(brotli -c "$main_file" | wc -c)
                      else
                        gzip_size=0
                        brotli_size=0
                      fi

                      sizes_json=$(echo "$sizes_json" | jq --arg name "$pkg_name" \
                        --argjson raw "$raw_size" \
                        --argjson gzip "$gzip_size" \
                        --argjson brotli "$brotli_size" \
                        '.packages += [{name: $name, raw: $raw, gzip: $gzip, brotli: $brotli}]')
                    fi
                  done

                  echo "$sizes_json" > ../base-sizes.json
                  cat ../base-sizes.json

            - name: Post Bundle Report
              uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
              with:
                  script: |
                      const fs = require('fs');
                      const { run } = await import('${{ github.workspace }}/.github/scripts/report.ts');
                      await run({
                        context: { repo: context.repo, payload: { action: 'opened', issue: {} } },
                        core,
                        github,
                        spec: {
                          kind: 'bundle',
                          pr: JSON.parse(fs.readFileSync('pr-sizes.json', 'utf8')),
                          base: JSON.parse(fs.readFileSync('base-sizes.json', 'utf8')),
                          n: context.payload.pull_request.number
                        }
                      });
