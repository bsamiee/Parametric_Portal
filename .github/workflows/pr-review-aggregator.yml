name: PR Review Aggregator

on:
    workflow_run:
        workflows: ["CI", "Claude Code Review"]
        types: [completed]
    pull_request_review:
        types: [submitted]
    issue_comment:
        types: [created]

concurrency:
    group: pr-aggregator-${{ github.event.pull_request.number || github.event.issue.number || github.run_id }}
    cancel-in-progress: true

permissions:
    contents: read
    pull-requests: write
    checks: read

jobs:
    aggregate:
        if: |
            (github.event_name == 'workflow_run') ||
            (github.event_name == 'pull_request_review') ||
            (github.event_name == 'issue_comment' &&
             github.event.issue.pull_request &&
             contains(github.event.comment.body, '/summarize'))
        runs-on: ubuntu-latest

        steps:
            - name: Get PR Number
              id: pr
              uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
              with:
                  script: |
                      let prNumber;
                      if (context.eventName === 'workflow_run') {
                        const { data: prs } = await github.rest.pulls.list({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`,
                          state: 'open'
                        });
                        prNumber = prs[0]?.number;
                      } else if (context.eventName === 'pull_request_review') {
                        prNumber = context.payload.pull_request.number;
                      } else {
                        prNumber = context.payload.issue.number;
                      }
                      if (!prNumber) {
                        core.setFailed('Could not determine PR number');
                        return;
                      }
                      core.setOutput('number', prNumber);

            - name: Checkout
              uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

            - name: Collect Reviews
              id: reviews
              uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
              with:
                  script: |
                      const prNumber = ${{ steps.pr.outputs.number }};

                      // Get all reviews
                      const { data: reviews } = await github.rest.pulls.listReviews({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        pull_number: prNumber
                      });

                      // Get check runs
                      const { data: pr } = await github.rest.pulls.get({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        pull_number: prNumber
                      });

                      const { data: checks } = await github.rest.checks.listForRef({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        ref: pr.head.sha
                      });

                      const summary = {
                        reviews: reviews.map(r => ({
                          author: r.user.login,
                          state: r.state,
                          body: r.body?.substring(0, 500) || ''
                        })),
                        checks: checks.check_runs.map(c => ({
                          name: c.name,
                          status: c.status,
                          conclusion: c.conclusion
                        }))
                      };

                      core.setOutput('data', JSON.stringify(summary));

            - name: Synthesize Summary
              id: synthesize
              uses: anthropics/claude-code-action@a7e4c51380c42dd89b127f5e5f9be7b54020bc6b # v1
              with:
                  claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
                  prompt: |
                      Synthesize PR #${{ steps.pr.outputs.number }} review data into a structured summary.

                      Review Data:
                      ```json
                      ${{ steps.reviews.outputs.data }}
                      ```

                      Generate a markdown summary with these exact sections:

                      ## Overall Assessment
                      - **Risk**: LOW | MEDIUM | HIGH (based on review concerns)
                      - **Merge Readiness**: BLOCKED | CAUTION | SAFE

                      ## Required Actions (blocking)
                      - List any changes required before merge
                      - "None" if ready

                      ## Quality Signals
                      | Check | Status |
                      |-------|--------|
                      (list all CI checks)

                      ## Nits (non-blocking)
                      - List style/minor suggestions
                      - "None" if no nits

                      ## Agent Provenance
                      - List which reviewers (human/bot) provided feedback

                      Output ONLY the markdown, no preamble.
                  claude_args: |
                      --model claude-sonnet-4-5-20250929
                      --max-turns 3
                      --allowedTools Read

            - name: Post Summary Comment
              uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
              with:
                  script: |
                      const prNumber = ${{ steps.pr.outputs.number }};
                      const marker = '<!-- PR-AGGREGATOR-SUMMARY -->';
                      const summary = `${marker}\n${{ steps.synthesize.outputs.claude_response || '## Summary\n\nNo synthesis available.' }}`;

                      // Find existing comment
                      const { data: comments } = await github.rest.issues.listComments({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: prNumber
                      });

                      const existing = comments.find(c => c.body?.includes(marker));

                      if (existing) {
                        await github.rest.issues.updateComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          comment_id: existing.id,
                          body: summary
                        });
                      } else {
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: prNumber,
                          body: summary
                        });
                      }
