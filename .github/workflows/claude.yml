# Claude Code Action - Official Anthropic Integration
# Reference: https://github.com/anthropics/claude-code-action
# Version: v1 (tracks latest v1.x release)

name: Claude Code

on:
    # Auto-detect mode: @claude mentions, issue assignment, label triggers
    issue_comment:
        types: [created]
    pull_request_review_comment:
        types: [created]
    issues:
        types: [opened, labeled, assigned]
    pull_request:
        types: [opened, synchronize, ready_for_review, reopened]
    pull_request_review:
        types: [submitted]

concurrency:
    group: claude-${{ github.event.pull_request.number || github.event.issue.number || github.run_id }}
    cancel-in-progress: true

permissions:
    contents: read
    pull-requests: write
    issues: write
    id-token: write

jobs:
    # Auto-review PRs with REQUIREMENTS.md compliance
    review:
        name: Claude Review
        if: github.event_name == 'pull_request'
        runs-on: ubuntu-latest
        timeout-minutes: 15
        steps:
            - name: Checkout
              uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
              with:
                  fetch-depth: 1

            - name: Claude Code Review
              uses: anthropics/claude-code-action@cc28cf34ba37e7abe223f1198e98333275a7139d # v1
              with:
                  claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
                  track_progress: true
                  use_sticky_comment: true
                  prompt: |
                      REPO: ${{ github.repository }}
                      PR NUMBER: ${{ github.event.pull_request.number }}

                      Review this PR for REQUIREMENTS.md compliance (Parametric Portal standards).

                      ## FORBIDDEN PATTERNS (fail review if found)
                      1. `any` type (except experimental APIs with justification)
                      2. `var` or `let` (must use `const`)
                      3. `if/else` chains (use dispatch tables or ternaries)
                      4. `for`/`while` loops (use .map/.filter/Effect)
                      5. `try/catch` (use Effect error channel)
                      6. `console.log` in production (allowed in scripts/)

                      ## REQUIRED PATTERNS
                      1. Single B constant - `Object.freeze({...} as const)`
                      2. Dispatch tables for mode switching
                      3. Effect.Effect<T, E, R> for async operations
                      4. Option.match for nullable handling
                      5. Section separators (77-char `// --- Name ---`) for >50 LOC

                      ## EXEMPTIONS
                      - `*.config.ts`: default exports allowed
                      - `*.{test,spec}.ts`: test utilities allowed
                      - `plugins/*`: side effects allowed

                      Use inline comments for code-specific feedback.
                      Use `gh pr comment` for top-level summary.

                  claude_args: |
                      --model claude-sonnet-4-5-20250929
                      --max-turns 10
                      --allowedTools mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Read,Grep,Glob

    # Interactive assistant for @claude mentions
    assistant:
        name: Claude Assistant
        if: |
            (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') &&
            contains(github.event.comment.body, '@claude')
        runs-on: ubuntu-latest
        timeout-minutes: 20
        steps:
            - name: Checkout
              uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
              with:
                  fetch-depth: 0

            - name: Claude Assistant
              uses: anthropics/claude-code-action@cc28cf34ba37e7abe223f1198e98333275a7139d # v1
              with:
                  claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
                  trigger_phrase: "@claude"
                  allowed_bots: "dependabot[bot],renovate[bot]"
                  claude_args: |
                      --model claude-sonnet-4-5-20250929
                      --max-turns 15
                      --allowedTools mcp__github_inline_comment__create_inline_comment,Bash(gh:*),Bash(pnpm:*),Bash(git:*),Read,Write,Edit,Grep,Glob

    # Issue implementation for assigned/labeled issues
    implement:
        name: Claude Implement
        if: |
            github.event_name == 'issues' &&
            ((github.event.action == 'labeled' && github.event.label.name == 'claude') ||
            (github.event.action == 'assigned' && github.event.assignee.login == 'claude'))
        runs-on: ubuntu-latest
        timeout-minutes: 30
        steps:
            - name: Checkout
              uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
              with:
                  fetch-depth: 0

            - name: Claude Implement
              uses: anthropics/claude-code-action@cc28cf34ba37e7abe223f1198e98333275a7139d # v1
              with:
                  claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
                  label_trigger: "claude"
                  assignee_trigger: "claude"
                  track_progress: true
                  prompt: |
                      REPO: ${{ github.repository }}
                      ISSUE NUMBER: ${{ github.event.issue.number }}
                      TITLE: ${{ github.event.issue.title }}

                      Implement the feature/fix described in this issue.

                      ## REQUIREMENTS
                      Follow REQUIREMENTS.md patterns:
                      - Single B constant for config
                      - Dispatch tables (no if/else)
                      - Effect for async, Option for nullable
                      - Expression-only style
                      - 77-char section separators

                      ## WORKFLOW
                      1. Read the issue body and comments
                      2. Research relevant code
                      3. Implement with proper patterns
                      4. Run `pnpm typecheck && pnpm check`
                      5. Create PR with changes

                  claude_args: |
                      --model claude-sonnet-4-5-20250929
                      --max-turns 25
                      --allowedTools Bash(gh:*),Bash(pnpm:*),Bash(git:*),Read,Write,Edit,Grep,Glob
