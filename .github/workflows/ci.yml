name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  schedule:
    - cron: '0 0 * * 1'

permissions:
  contents: write
  actions: read
  issues: write
  pull-requests: write
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # --- Normalize Commit (Independent) ---------------------------------------
  normalize-commit:
    name: Normalize Commit
    if: github.event_name == 'push' && startsWith(github.event.head_commit.message, '[')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      - uses: ./.github/actions/node-env
      - uses: ./.github/actions/normalize-commit

  # --- Quality Gate ---------------------------------------------------------
  quality:
    name: Code Quality
    if: github.event_name != 'schedule'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      actions: read
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.ref || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Derive Nx SHAs
        uses: nrwl/nx-set-shas@v4
        with:
          main-branch-name: main
          workflow-id: ci.yml

      - name: Setup Environment
        uses: ./.github/actions/node-env

      - name: Restore Nx Cache
        uses: actions/cache@v4
        with:
          path: |
            .nx/cache
            node_modules/.cache
          key: nx-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ github.sha }}
          restore-keys: |
            nx-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}-
            nx-${{ runner.os }}-

      - name: Setup Git Identity
        if: github.event_name == 'pull_request'
        uses: ./.github/actions/git-identity

      - name: Auto Fix (Biome)
        id: auto-fix
        if: github.event_name == 'pull_request'
        uses: ./.github/actions/auto-fix
        with:
          command: pnpm exec biome check --write --unsafe .
          commit-message: 'style: biome auto-repair'

      - name: Comment on Biome Repair
        if: github.event_name == 'pull_request' && steps.auto-fix.outputs.has-changes == 'true'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        env:
          NODE_OPTIONS: --import tsx
        with:
          script: |
            const { mutate, createCtx } = await import('${{ github.workspace }}/.github/scripts/schema.ts');
            await mutate(createCtx({ context, core, github }), {
              t: 'comment',
              n: context.payload.pull_request.number,
              marker: 'PR-MONITOR',
              mode: 'section',
              sectionId: 'biome-repair',
              body: '[OK] **Biome Auto-Repair Applied**: Style issues fixed and committed.'
            });

      - name: Quality Gates (Lint, Typecheck, Build)
        if: steps.auto-fix.outputs.has-changes != 'true'
        run: pnpm exec nx affected -t lint,typecheck,build --parallel=4

      - name: Get Playwright version
        if: steps.auto-fix.outputs.has-changes != 'true'
        id: playwright-version
        run: echo "version=$(pnpm list @playwright/test --json 2>/dev/null | jq -r '.[0].dependencies["@playwright/test"].version // "1.57.0"')" >> "$GITHUB_OUTPUT"

      - name: Cache Playwright browsers
        if: steps.auto-fix.outputs.has-changes != 'true'
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}

      - name: Install Playwright browsers (cache miss)
        if: steps.auto-fix.outputs.has-changes != 'true' && steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm exec playwright install chromium --with-deps

      - name: Install Playwright deps (cache hit)
        if: steps.auto-fix.outputs.has-changes != 'true' && steps.playwright-cache.outputs.cache-hit == 'true'
        run: pnpm exec playwright install-deps chromium

      - name: Test
        if: steps.auto-fix.outputs.has-changes != 'true'
        run: pnpm exec nx affected -t test -- --coverage

      - name: Upload Coverage
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ci-artifacts
          path: '**/coverage'
          if-no-files-found: ignore
          retention-days: 7

      - name: Job Summary
        if: always()
        run: |
          {
            echo "## CI Summary"
            echo ""
            echo "### Affected Projects"
            pnpm exec nx show projects --affected --json | jq -r '.[] | "- " + .' || echo "- None"
            echo ""
            echo "### Quick Links"
            echo "- [Artifacts](#artifacts) - Coverage reports and project graph"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Create Quality Debt Issue
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        env:
          NODE_OPTIONS: --import tsx
        with:
          script: |
            const { run } = await import('${{ github.workspace }}/.github/scripts/failure-alert.ts');
            await run({
              context: { repo: context.repo, payload: context.payload },
              core,
              github,
              spec: {
                kind: 'ci',
                job: '${{ github.job }}',
                runUrl: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}',
                prNumber: context.payload.pull_request.number
              }
            });

  # --- Security Scanning (parallel with quality) ----------------------------
  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          sparse-checkout: |
            .github/actions
            package.json
            pnpm-lock.yaml
            .npmrc

      - uses: ./.github/actions/node-env
        with:
          install: 'false'

      - name: Run pnpm audit
        id: audit
        run: |
          set +e
          pnpm audit --audit-level=moderate --json > audit-results.json
          exit_code=$?
          set -e
          if [ "$exit_code" -ne 0 ] && [ "$exit_code" -ne 1 ]; then
            echo "[ERROR] Audit command failed with exit code $exit_code"
            cat audit-results.json
            exit "$exit_code"
          fi
          cat audit-results.json

      - name: Check for Critical Vulnerabilities
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            const fs = require('fs');
            const auditResults = JSON.parse(fs.readFileSync('audit-results.json', 'utf8'));
            const vulns = auditResults.metadata?.vulnerabilities || {};
            const critical = vulns.critical || 0;
            const high = vulns.high || 0;
            core.info(`[PASS] Vulnerability summary: ${critical} critical, ${high} high`);
            if (critical > 0 || high > 0) {
              const advisories = auditResults.advisories || {};
              for (const [id, advisory] of Object.entries(advisories)) {
                if (advisory.severity === 'critical' || advisory.severity === 'high') {
                  core.error(`[${advisory.severity.toUpperCase()}] ${advisory.module_name}: ${advisory.title}`);
                }
              }
              core.setFailed(`Found ${critical} critical and ${high} high severity vulnerabilities`);
            }

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.8.2
        with:
          fail-on-severity: high
          allow-licenses: >-
            MIT, MIT-0, Apache-2.0, ISC, BSD-2-Clause, BSD-3-Clause, CC0-1.0, Unlicense,
            BlueOak-1.0.0, 0BSD, Python-2.0, WTFPL
          license-check: false

  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - uses: github/codeql-action/init@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9
        with:
          languages: javascript-typescript
          queries: security-and-quality

      - uses: github/codeql-action/autobuild@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9

      - uses: github/codeql-action/analyze@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9
        with:
          category: '/language:javascript-typescript'

  secrets-scan:
    name: Secrets Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          fetch-depth: 0

      - uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2.3.9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_SUMMARY: true

  # --- Unified Summary ------------------------------------------------------
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [quality, dependency-audit, dependency-review, codeql, secrets-scan]
    if: always()
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          sparse-checkout: |
            .github/scripts
            .github/actions
            package.json
            pnpm-workspace.yaml
            pnpm-lock.yaml

      - uses: ./.github/actions/node-env

      - name: Generate Summary
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        env:
          NODE_OPTIONS: --import tsx
        with:
          script: |
            const { fn } = await import('${{ github.workspace }}/.github/scripts/schema.ts');

            const results = {
              quality: '${{ needs.quality.result }}',
              'dependency-audit': '${{ needs.dependency-audit.result }}',
              'dependency-review': '${{ needs.dependency-review.result }}',
              codeql: '${{ needs.codeql.result }}',
              'secrets-scan': '${{ needs.secrets-scan.result }}'
            };

            const qualityRows = [['Code Quality', results.quality]];
            const securityRows = [
              ['Dependency Audit', results['dependency-audit']],
              ['Dependency Review', results['dependency-review']],
              ['CodeQL Analysis', results.codeql],
              ['Secrets Scan', results['secrets-scan']]
            ];

            const qualityTable = fn.report('Quality Checks', ['Check', 'Status'], qualityRows, {});
            const securityTable = fn.report('Security Scans', ['Check', 'Status'], securityRows, {});

            const failures = Object.entries(results).filter(([_, status]) => status === 'failure');
            const statusMsg = failures.length > 0
              ? `[ERROR] ${failures.length} check(s) failed`
              : '[OK] All checks passed';

            const summary = `# CI & Security Summary\n\n${qualityTable}\n\n${securityTable}\n\n${statusMsg}`;
            core.summary.addRaw(summary).write();

            if (failures.length > 0) {
              core.setFailed(statusMsg);
            }

  # --- Release --------------------------------------------------------------
  release:
    name: Release
    needs: [quality, dependency-audit, codeql, secrets-scan]
    if: github.event_name == 'push' && !contains(github.event.head_commit.message, 'chore(release)')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          fetch-depth: 0

      - uses: ./.github/actions/node-env

      - uses: ./.github/actions/git-identity

      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: pnpm nx release
