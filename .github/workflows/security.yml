name: Security Scanning

on:
    pull_request:
        branches: [main]
    push:
        branches: [main]
    schedule:
        - cron: '0 0 * * 1' # Weekly on Monday

permissions:
    contents: read
    security-events: write
    issues: write
    pull-requests: write

concurrency:
    group: security-${{ github.event.pull_request.number || github.ref }}
    cancel-in-progress: true

jobs:
    dependency-audit:
        name: Dependency Audit
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

            - name: Setup Environment
              uses: ./.github/actions/node-env
              with:
                  install: 'false'

            - name: Run pnpm audit
              id: audit
              run: |
                  pnpm audit --audit-level=moderate --json > audit-results.json
                  exit_code=$?
                  if [ "$exit_code" -ne 0 ] && [ "$exit_code" -ne 1 ]; then
                    echo "[ERROR] Audit command failed"
                    cat audit-results.json
                    exit "$exit_code"
                  fi
                  cat audit-results.json

            - name: Check for Critical Vulnerabilities
              uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
              with:
                  script: |
                      const fs = require('fs');
                      const auditResults = JSON.parse(fs.readFileSync('audit-results.json', 'utf8'));

                      // pnpm audit JSON structure: { advisories: { [id]: advisory }, metadata: { vulnerabilities: { critical, high, ... } } }
                      const vulns = auditResults.metadata?.vulnerabilities || {};
                      const critical = vulns.critical || 0;
                      const high = vulns.high || 0;

                      core.info(`Vulnerability summary: ${critical} critical, ${high} high`);

                      if (critical > 0 || high > 0) {
                        // Log advisory details
                        const advisories = auditResults.advisories || {};
                        for (const [id, advisory] of Object.entries(advisories)) {
                          if (advisory.severity === 'critical' || advisory.severity === 'high') {
                            core.error(`[${advisory.severity.toUpperCase()}] ${advisory.module_name}: ${advisory.title}`);
                          }
                        }
                        core.setFailed(`Found ${critical} critical and ${high} high severity vulnerabilities`);
                      }

    codeql:
        name: CodeQL Analysis
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

            - name: Initialize CodeQL
              uses: github/codeql-action/init@fdbfb4d2750291e159f0156def62b853c2798ca2 # v4.31.5
              with:
                  languages: javascript-typescript
                  queries: security-and-quality

            - name: Autobuild
              uses: github/codeql-action/autobuild@fdbfb4d2750291e159f0156def62b853c2798ca2 # v4.31.5

            - name: Perform CodeQL Analysis
              uses: github/codeql-action/analyze@fdbfb4d2750291e159f0156def62b853c2798ca2 # v4.31.5
              with:
                  category: '/language:javascript-typescript'

    secrets-scan:
        name: Secrets Scanning
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
              with:
                  fetch-depth: 0

            - name: Run Gitleaks
              uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2.3.9
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  GITLEAKS_ENABLE_SUMMARY: true

    license-check:
        name: License Compliance
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

            - name: Setup Environment
              uses: ./.github/actions/node-env

            - name: Check for Copyleft Licenses
              run: |
                  echo "Checking for copyleft licenses in production dependencies..."
                  pnpm licenses list --json > licenses.json

                  # Check for strict copyleft (GPL, AGPL) that are NOT:
                  # 1. Dual-licensed with MIT (MIT OR GPL)
                  # 2. LGPL (which is acceptable for linking)
                  # Note: jszip uses "MIT OR GPL-3.0-or-later" - MIT takes precedence
                  # Note: sharp's libvips bindings use LGPL-3.0-or-later - acceptable for dynamic linking
                  COPYLEFT=$(cat licenses.json | jq -r '
                    .[] |
                    select(.license | test("GPL|AGPL"; "i")) |
                    select(.license | test("^LGPL"; "i") | not) |
                    select(.license | test("MIT OR"; "i") | not) |
                    "\(.name): \(.license)"
                  ' 2>/dev/null || echo "")

                  if [[ -n "$COPYLEFT" ]]; then
                    echo "[ERROR] Strict copyleft licenses detected:"
                    echo "$COPYLEFT"
                    exit 1
                  else
                    echo "[OK] No problematic copyleft licenses detected"
                  fi

    create-security-issue:
        name: Create Security Issue
        runs-on: ubuntu-latest
        needs: [dependency-audit, codeql, secrets-scan, license-check]
        if: failure()
        steps:
            - name: Checkout
              uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

            - name: Create Security Alert
              uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
              with:
                  script: |
                      const { run } = await import('${{ github.workspace }}/.github/scripts/failure-alert.ts');
                      await run({
                        context: { repo: context.repo, payload: { action: 'created', issue: {} } },
                        core,
                        github,
                        spec: { kind: 'security', runUrl: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}` }
                      });
