name: 'Gemini Dispatch'

# IMPORTANT: Using pull_request_target to bypass first-time contributor approval requirements.
# Comment-based triggers (issue_comment, pull_request_review_comment) run in base context anyway.
on:
  pull_request_review_comment:
    types:
      - 'created'
  pull_request_review:
    types:
      - 'submitted'
  pull_request_target:
    types:
      - 'opened'
      - 'ready_for_review'
  issue_comment:
    types:
      - 'created'

defaults:
  run:
    shell: 'bash'

# NOTE: Concurrency handled by reusable workflows (gemini-review.yml, gemini-invoke.yml).
# Parent dispatch can run multiple times; child workflows dedupe via their own concurrency groups.

jobs:
  debugger:
    if: vars.DEBUG == 'true' || vars.ACTIONS_STEP_DEBUG == 'true'
    runs-on: 'ubuntu-latest'
    permissions:
      contents: 'read'
    steps:
      - name: 'Print context for debugging'
        env:
          DEBUG_event_name: '${{ github.event_name }}'
          DEBUG_event__action: '${{ github.event.action }}'
          DEBUG_event__comment__author_association: '${{ github.event.comment.author_association }}'
          DEBUG_event__issue__author_association: '${{ github.event.issue.author_association }}'
          DEBUG_event__pull_request__author_association: '${{ github.event.pull_request.author_association }}'
          DEBUG_event__review__author_association: '${{ github.event.review.author_association }}'
          DEBUG_event: '${{ toJSON(github.event) }}'
        run: |-
          env | grep '^DEBUG_'

  dispatch:
    # For PRs: auto-review on open (skip drafts, only same-repo PRs)
    # For comments: @gemini or @gemini-cli prefix, trusted associations only
    if: |-
      (github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name == github.repository && !github.event.pull_request.draft) || (
        (startsWith(github.event.comment.body || github.event.review.body, '@gemini-cli') || startsWith(github.event.comment.body || github.event.review.body, '@gemini ')) &&
        contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR", "CONTRIBUTOR"]'), github.event.comment.author_association || github.event.review.author_association)
      )
    runs-on: 'ubuntu-latest'
    permissions:
      contents: 'read'
      issues: 'write'
      pull-requests: 'write'
    outputs:
      command: '${{ steps.extract_command.outputs.command }}'
      request: '${{ steps.extract_command.outputs.request }}'
      additional_context: '${{ steps.extract_command.outputs.additional_context }}'
      issue_number: '${{ github.event.pull_request.number || github.event.issue.number }}'
    steps:
      - name: 'Extract command'
        id: 'extract_command'
        uses: 'actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b' # v7
        env:
          EVENT_TYPE: '${{ github.event_name }}.${{ github.event.action }}'
          REQUEST: '${{ github.event.comment.body || github.event.review.body }}'
        with:
          script: |
            const eventType = process.env.EVENT_TYPE;
            const request = process.env.REQUEST || '';
            core.setOutput('request', request);

            if (eventType === 'pull_request_target.opened' || eventType === 'pull_request_target.ready_for_review') {
              core.setOutput('command', 'review');
            } else if (request.startsWith('@gemini-cli /review') || request.startsWith('@gemini /review')) {
              core.setOutput('command', 'review');
              const additionalContext = request.replace(/^@gemini(?:-cli)? \/review/, '').trim();
              core.setOutput('additional_context', additionalContext);
            } else if (request.startsWith('@gemini-cli') || request.startsWith('@gemini ')) {
              const additionalContext = request.replace(/^@gemini(?:-cli)?/, '').trim();
              core.setOutput('command', 'invoke');
              core.setOutput('additional_context', additionalContext);
            } else {
              core.setOutput('command', 'fallthrough');
            }

      - name: 'Acknowledge request'
        if: github.event_name != 'pull_request_target'
        env:
          GITHUB_TOKEN: '${{ github.token }}'
          ISSUE_NUMBER: '${{ github.event.pull_request.number || github.event.issue.number }}'
          MESSAGE: |-
            [!] Hi @${{ github.actor }}, I've received your request, and I'm working on it now! You can track my progress [in the logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for more details.
          REPOSITORY: '${{ github.repository }}'
        run: |-
          gh issue comment "${ISSUE_NUMBER}" \
            --body "${MESSAGE}" \
            --repo "${REPOSITORY}"

  review:
    needs: 'dispatch'
    if: |-
      ${{ needs.dispatch.outputs.command == 'review' }}
    uses: './.github/workflows/gemini-review.yml'
    permissions:
      contents: 'read'
      id-token: 'write'
      issues: 'write'
      pull-requests: 'write'
    with:
      additional_context: '${{ needs.dispatch.outputs.additional_context }}'
    secrets:
      GEMINI_API_KEY: '${{ secrets.GEMINI_API_KEY }}'

  invoke:
    needs: 'dispatch'
    if: |-
      ${{ needs.dispatch.outputs.command == 'invoke' }}
    uses: './.github/workflows/gemini-invoke.yml'
    permissions:
      contents: 'read'
      id-token: 'write'
      issues: 'write'
      pull-requests: 'write'
    with:
      additional_context: '${{ needs.dispatch.outputs.additional_context }}'
    secrets:
      GEMINI_API_KEY: '${{ secrets.GEMINI_API_KEY }}'

  fallthrough:
    needs:
      - 'dispatch'
      - 'review'
      - 'invoke'
    if: |-
      ${{ always() && !cancelled() && (failure() || needs.dispatch.outputs.command == 'fallthrough') }}
    runs-on: 'ubuntu-latest'
    permissions:
      contents: 'read'
      issues: 'write'
      pull-requests: 'write'
    steps:
      - name: 'Send failure comment'
        env:
          GITHUB_TOKEN: '${{ github.token }}'
          ISSUE_NUMBER: '${{ github.event.pull_request.number || github.event.issue.number }}'
          MESSAGE: |-
            [x] I'm sorry @${{ github.actor }}, but I was unable to process your request. Please [see the logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for more details.
          REPOSITORY: '${{ github.repository }}'
        run: |-
          gh issue comment "${ISSUE_NUMBER}" \
            --body "${MESSAGE}" \
            --repo "${REPOSITORY}"
