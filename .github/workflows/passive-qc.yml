name: Passive QC

on:
    schedule:
        # Run at :15 to avoid race conditions with dashboard.yml (:00)
        - cron: '15 */6 * * *'
        # Daily maintenance at 03:00 UTC
        - cron: '0 3 * * *'
    workflow_dispatch:
        inputs:
            maintenance:
                description: 'Run maintenance cleanup'
                required: false
                type: boolean
                default: false

concurrency:
    group: passive-qc
    cancel-in-progress: false

permissions:
    contents: write
    issues: write
    pull-requests: write
    actions: write
    models: read

jobs:
    # --- Jobs run in sequence via needs chain for deterministic execution -----
    sync-labels:
        name: Sync Labels (backup)
        if: github.event.schedule != '0 3 * * *' && github.event.inputs.maintenance != 'true'
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
              with:
                  sparse-checkout: .github/labels.yml
                  sparse-checkout-cone-mode: false

            - uses: crazy-max/ghaction-github-labeler@24d110aa46a59976b8a7f35518cb7f14f434c916 # v5.3.0
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  yaml-file: .github/labels.yml
                  skip-delete: true

    stale-management:
        name: Stale Management
        needs: sync-labels
        if: always() && (needs.sync-labels.result == 'success' || needs.sync-labels.result == 'skipped') && github.event.schedule != '0 3 * * *' && github.event.inputs.maintenance != 'true'
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
              with:
                  sparse-checkout: |
                      .github/actions/issue-ops
                      .github/scripts/schema.ts
                  sparse-checkout-cone-mode: false

            # Mark inactive issues/PRs with stale label
            - name: Check Inactive Items
              uses: ./.github/actions/issue-ops
              with:
                  operation: check-inactive
                  inactive-day: '3'
                  inactive-mode: 'comment,issue'
                  inactive-label: 'stale'
                  exclude-labels: 'critical,implement,pinned,security'
                  issue-state: 'open'

            # Close issues/PRs marked stale for 7+ days
            - name: Close Stale Items
              uses: ./.github/actions/issue-ops
              with:
                  operation: close-issues
                  inactive-day: '7'
                  inactive-mode: 'comment,issue'
                  labels: 'stale'
                  exclude-labels: 'critical,implement,pinned,security'
                  close-reason: 'not_planned'
                  issue-state: 'open'

    aging-report:
        name: Aging Report
        needs: stale-management
        if: always() && (needs.stale-management.result == 'success' || needs.stale-management.result == 'skipped') && github.event.schedule != '0 3 * * *' && github.event.inputs.maintenance != 'true'
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
              with:
                  sparse-checkout: |
                      .github/scripts
                      .github/actions
                      package.json
                      pnpm-workspace.yaml
                      pnpm-lock.yaml

            - uses: ./.github/actions/node-env
              with:
                  node-version-file: package.json

            - uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
              env:
                  NODE_OPTIONS: --import tsx
              with:
                  script: |
                      const { run } = await import('${{ github.workspace }}/.github/scripts/report.ts');
                      await run({
                        context: { repo: context.repo, payload: { action: 'scheduled', issue: {} } },
                        core,
                        github,
                        spec: { kind: 'aging' }
                      });

    meta-consistency:
        name: Meta Consistency
        needs: aging-report
        if: always() && (needs.aging-report.result == 'success' || needs.aging-report.result == 'skipped') && github.event.schedule != '0 3 * * *' && github.event.inputs.maintenance != 'true'
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
              with:
                  sparse-checkout: |
                      .github
                      package.json
                      pnpm-workspace.yaml
                      pnpm-lock.yaml

            - uses: ./.github/actions/meta-fixer
              with:
                  targets: title,label,body
                  limit: '10'
                  anthropic_api_key: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

    # --- Daily Maintenance Jobs (03:00 UTC or manual trigger) -----------------
    branch-cleanup:
        name: Branch Cleanup
        if: github.event.schedule == '0 3 * * *' || github.event.inputs.maintenance == 'true'
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
              with:
                  sparse-checkout: |
                      .github/scripts
                      .github/actions
                      package.json
                      pnpm-workspace.yaml
                      pnpm-lock.yaml

            - uses: ./.github/actions/node-env
              with:
                  node-version-file: package.json

            - name: Branch Maintenance
              uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
              env:
                  NODE_OPTIONS: --import tsx
              with:
                  script: |
                      const { run } = await import('${{ github.workspace }}/.github/scripts/maintenance.ts');
                      await run({
                        context: { repo: context.repo, payload: { action: 'scheduled', issue: {} } },
                        core,
                        github,
                        spec: { kind: 'branches', dryRun: false }
                      });

    cache-cleanup:
        name: Cache & Artifact Cleanup
        if: github.event.schedule == '0 3 * * *' || github.event.inputs.maintenance == 'true'
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            - name: Cleanup Workflow Runs
              uses: viascom/github-maintenance-action@v0.1.0
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  repository: ${{ github.repository }}
                  retention_days: 7
                  keep_minimum_runs: 5
                  delete_logs: false
                  delete_artifacts: true
                  dry_run: false

            - name: Cleanup Stale Caches
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  echo "[INFO] Fetching cache entries older than 7 days..."
                  CUTOFF_DATE=$(date -u -d '7 days ago' +%Y-%m-%dT%H:%M:%SZ)
                  
                  # List and delete caches older than retention period (no limit)
                  gh cache list --json id,createdAt --jq ".[] | select(.createdAt < \"$CUTOFF_DATE\") | .id" | while read -r cache_id; do
                    [ -n "$cache_id" ] && echo "[INFO] Deleting cache: $cache_id" && gh cache delete "$cache_id" || true
                  done
                  
                  echo "[OK] Cache cleanup complete"

    maintenance-summary:
        name: Maintenance Summary
        needs: [branch-cleanup, cache-cleanup]
        if: always() && (github.event.schedule == '0 3 * * *' || github.event.inputs.maintenance == 'true')
        runs-on: ubuntu-latest
        steps:
            - name: Generate Summary
              run: |
                  echo "## Maintenance Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Task | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
                  echo "| Branch Cleanup | ${{ needs.branch-cleanup.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Cache Cleanup | ${{ needs.cache-cleanup.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "_Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)_" >> $GITHUB_STEP_SUMMARY
