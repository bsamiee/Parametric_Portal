name: Passive QC

on:
    schedule:
        # Run at :15 to avoid race conditions with dashboard.yml (:00)
        - cron: '15 */6 * * *'
        # Daily maintenance at 03:00 UTC
        - cron: '0 3 * * *'
    workflow_dispatch:
        inputs:
            maintenance:
                description: 'Run maintenance cleanup'
                required: false
                type: boolean
                default: false

concurrency:
    group: passive-qc
    cancel-in-progress: false

permissions:
    contents: write
    issues: write
    pull-requests: write
    actions: write
    models: read

jobs:
    # --- Jobs run in sequence via needs chain for deterministic execution -----
    # QC jobs run every 6 hours; maintenance jobs run daily at 03:00
    sync-labels:
        name: Sync Labels (backup)
        if: github.event.schedule != '0 3 * * *' && github.event.inputs.maintenance != 'true'
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
              with:
                  sparse-checkout: .github/labels.yml
                  sparse-checkout-cone-mode: false

            - uses: crazy-max/ghaction-github-labeler@de749cf181958193cb7debf1a9c5bb28922a2fd6 # v5.1.0
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  yaml-file: .github/labels.yml
                  skip-delete: true

    stale-management:
        name: Stale Management
        needs: sync-labels
        if: always() && (needs.sync-labels.result == 'success' || needs.sync-labels.result == 'skipped') && github.event.schedule != '0 3 * * *' && github.event.inputs.maintenance != 'true'
        runs-on: ubuntu-latest
        steps:
            - uses: actions/stale@5bef64f19d7facfb25b37b414482c7164d639639 # v9.1.0
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}
                  stale-issue-message: |
                      This issue has been automatically marked as stale due to inactivity.
                      It will be closed in 7 days if there is no further activity.
                      Comment to keep it open.
                  stale-pr-message: |
                      This PR has been automatically marked as stale due to inactivity.
                      It will be closed in 7 days if there is no further activity.
                  stale-issue-label: stale
                  stale-pr-label: stale
                  days-before-stale: 3
                  days-before-close: 7
                  exempt-issue-labels: pinned,security,critical
                  exempt-pr-labels: pinned,security,critical

    aging-report:
        name: Aging Report
        needs: stale-management
        if: always() && (needs.stale-management.result == 'success' || needs.stale-management.result == 'skipped') && github.event.schedule != '0 3 * * *' && github.event.inputs.maintenance != 'true'
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
              with:
                  sparse-checkout: |
                      .github/scripts
                      .github/actions
                      package.json
                      pnpm-workspace.yaml
                      pnpm-lock.yaml

            - uses: ./.github/actions/node-env
              with:
                  node-version-file: package.json

            - uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
              env:
                  NODE_OPTIONS: --import tsx
              with:
                  script: |
                      const { run } = await import('${{ github.workspace }}/.github/scripts/report.ts');
                      await run({
                        context: { repo: context.repo, payload: { action: 'scheduled', issue: {} } },
                        core,
                        github,
                        spec: { kind: 'aging' }
                      });

    meta-consistency:
        name: Meta Consistency
        needs: aging-report
        if: always() && (needs.aging-report.result == 'success' || needs.aging-report.result == 'skipped') && github.event.schedule != '0 3 * * *' && github.event.inputs.maintenance != 'true'
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
              with:
                  sparse-checkout: |
                      .github
                      package.json
                      pnpm-workspace.yaml
                      pnpm-lock.yaml

            - uses: ./.github/actions/meta-fixer
              with:
                  targets: title,label,body
                  limit: '10'
                  anthropic_api_key: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

    # --- Daily Maintenance Jobs (03:00 UTC or manual trigger) -----------------
    branch-cleanup:
        name: Branch Cleanup
        # Run on daily schedule (03:00) or manual maintenance trigger
        if: github.event.schedule == '0 3 * * *' || github.event.inputs.maintenance == 'true'
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
              with:
                  sparse-checkout: |
                      .github/scripts
                      .github/actions
                      package.json
                      pnpm-workspace.yaml
                      pnpm-lock.yaml

            - uses: ./.github/actions/node-env
              with:
                  node-version-file: package.json

            - name: Branch Maintenance
              uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
              env:
                  NODE_OPTIONS: --import tsx
              with:
                  script: |
                      const { run } = await import('${{ github.workspace }}/.github/scripts/maintenance.ts');
                      await run({
                        context: { repo: context.repo, payload: { action: 'scheduled', issue: {} } },
                        core,
                        github,
                        spec: { kind: 'branches', dryRun: false }
                      });

    cache-cleanup:
        name: Cache & Artifact Cleanup
        if: github.event.schedule == '0 3 * * *' || github.event.inputs.maintenance == 'true'
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            # Workflow run cleanup (logs, artifacts older than 7 days)
            - name: Cleanup Workflow Runs
              uses: viascom/github-maintenance-action@aa3a556c67f6582ee9b7b75dd26fda08e66f3b82 # v0.0.3
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  repository: ${{ github.repository }}
                  retention_days: 7
                  keep_minimum_runs: 5
                  delete_logs: false
                  delete_artifacts: true
                  dry_run: false

            # Cache cleanup using gh CLI
            - name: Cleanup Stale Caches
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  echo "[INFO] Fetching cache entries older than 7 days..."
                  CUTOFF_DATE=$(date -d '7 days ago' +%Y-%m-%dT%H:%M:%SZ)
                  
                  # List and delete caches older than retention period
                  gh cache list --limit 100 --json id,createdAt --jq ".[] | select(.createdAt < \"$CUTOFF_DATE\") | .id" | while read -r cache_id; do
                    if [ -n "$cache_id" ]; then
                      echo "[INFO] Deleting cache: $cache_id"
                      gh cache delete "$cache_id" || true
                    fi
                  done
                  
                  echo "[OK] Cache cleanup complete"

    maintenance-summary:
        name: Maintenance Summary
        needs: [branch-cleanup, cache-cleanup]
        if: always() && (github.event.schedule == '0 3 * * *' || github.event.inputs.maintenance == 'true')
        runs-on: ubuntu-latest
        steps:
            - name: Generate Summary
              run: |
                  echo "## Maintenance Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Task | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
                  echo "| Branch Cleanup | ${{ needs.branch-cleanup.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Cache Cleanup | ${{ needs.cache-cleanup.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "_Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)_" >> $GITHUB_STEP_SUMMARY
