name: Passive QC

on:
    schedule:
        - cron: '15 */6 * * *'

concurrency:
    group: passive-qc
    cancel-in-progress: false

permissions:
    contents: write
    issues: write
    pull-requests: write
    models: read

jobs:
    sync-labels:
        name: Sync Labels (backup)
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - uses: crazy-max/ghaction-github-labeler@v5
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  yaml-file: .github/labels.yml
                  skip-delete: true

    stale-management:
        name: Stale Management
        runs-on: ubuntu-latest
        steps:
            - uses: actions/stale@v9
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}
                  stale-issue-message: |
                      This issue has been automatically marked as stale due to inactivity.
                      It will be closed in 7 days if there is no further activity.
                      Comment to keep it open.
                  stale-pr-message: |
                      This PR has been automatically marked as stale due to inactivity.
                      It will be closed in 7 days if there is no further activity.
                  stale-issue-label: stale
                  stale-pr-label: stale
                  days-before-stale: 3
                  days-before-close: 7
                  exempt-issue-labels: pinned,security,critical
                  exempt-pr-labels: pinned,security,critical

    aging-report:
        name: Aging Report
        needs: stale-management
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  sparse-checkout: |
                      .github/scripts
                      .github/actions
                      package.json
                      pnpm-workspace.yaml

            - uses: ./.github/actions/node-env
              with:
                  node-version-file: package.json

            - uses: actions/github-script@v7
              env:
                  NODE_OPTIONS: --import tsx
              with:
                  script: |
                      const { run } = await import('${{ github.workspace }}/.github/scripts/report.ts');
                      await run({
                        context: { repo: context.repo, payload: { action: 'scheduled', issue: {} } },
                        core,
                        github,
                        spec: { kind: 'aging' }
                      });

    meta-consistency:
        name: Meta Consistency
        needs: aging-report
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            - uses: actions/checkout@v4
              with:
                  sparse-checkout: .github

            - uses: ./.github/actions/meta-fixer
              with:
                  targets: title,label,body
                  limit: '10'
                  anthropic_api_key: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
