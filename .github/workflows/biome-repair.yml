name: Biome Auto-Repair

on:
    pull_request:
        types: [opened, synchronize]

permissions:
    contents: write
    pull-requests: write

concurrency:
    group: biome-repair-${{ github.event.pull_request.number }}
    cancel-in-progress: true

jobs:
    auto-fix:
        name: Auto-Fix Style Issues
        runs-on: ubuntu-latest
        steps:
            - name: Checkout PR
              uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
              with:
                  ref: ${{ github.event.pull_request.head.ref }}
                  token: ${{ secrets.GITHUB_TOKEN }}
                  fetch-depth: 0

            - name: Setup Environment
              uses: ./.github/actions/node-env
              with:
                  nx: 'true'
                  nx-cloud-token: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

            - name: Setup Git Identity
              uses: ./.github/actions/git-identity

            - name: Run Biome Auto-Repair
              id: repair
              run: |
                  pnpm exec biome check --write --unsafe .
                  exit_code=$?
                  if [ "$exit_code" -eq 0 ]; then
                    echo "fixed=false" >> $GITHUB_OUTPUT
                  elif [ "$exit_code" -eq 1 ]; then
                    echo "fixed=true" >> $GITHUB_OUTPUT
                  else
                    echo "[ERROR] Biome encountered a fatal error"
                    exit "$exit_code"
                  fi

            - name: Check for Changes
              id: changes
              run: |
                  if [[ -n $(git status --porcelain) ]]; then
                    echo "has_changes=true" >> $GITHUB_OUTPUT
                  else
                    echo "has_changes=false" >> $GITHUB_OUTPUT
                  fi

            - name: Run Tests to Validate Safety
              if: steps.changes.outputs.has_changes == 'true'
              id: test
              run: |
                  if pnpm exec nx affected -t test --parallel=4; then
                    echo "tests_failed=false" >> $GITHUB_OUTPUT
                  else
                    echo "tests_failed=true" >> $GITHUB_OUTPUT
                  fi

            - name: Commit and Push Auto-Repairs
              if: |
                  steps.changes.outputs.has_changes == 'true' &&
                  steps.test.outputs.tests_failed != 'true'
              run: |
                  git add .
                  git commit -m "style: biome auto-repair
                  Co-authored-by: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
                  git push

            - name: Comment on Semantic Breakage
              if: |
                  steps.changes.outputs.has_changes == 'true' &&
                  steps.test.outputs.tests_failed == 'true'
              uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
              with:
                  script: |
                      await github.rest.issues.createComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: context.payload.pull_request.number,
                        body: `[WARN] Biome Auto-Repair Warning

                        Biome's \`--unsafe\` flag attempted to fix style issues, but tests failed after the changes.

                        **Action Required**: The unsafe transformations may have introduced semantic changes. Please:
                        1. Review the suggested fixes manually
                        2. Run \`pnpm check\` locally to see the issues
                        3. Apply safe fixes manually or refactor code to comply with Biome rules

                        Tests must pass before merging. Auto-repair has been skipped to prevent breaking changes.`
                      });

            - name: Comment on Successful Repair
              if: |
                  steps.changes.outputs.has_changes == 'true' &&
                  steps.test.outputs.tests_failed != 'true'
              uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
              with:
                  script: |
                      await github.rest.issues.createComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: context.payload.pull_request.number,
                        body: `[OK] Biome Auto-Repair Applied

                        Style issues have been automatically fixed and committed. All tests passed after repair.

                        You can continue with your review without addressing style nits.`
                      });
