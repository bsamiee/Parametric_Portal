name: Claude Code Review Enhanced

on:
    workflow_run:
        workflows: ["CI"]
        types: [completed]

concurrency:
    group: claude-review-${{ github.event.workflow_run.pull_requests[0].number }}
    cancel-in-progress: true

permissions:
    contents: read
    pull-requests: write
    issues: write
    id-token: write
    actions: read

jobs:
    requirements-review:
        if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.pull_requests[0]
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
              with:
                  node-version: "25.2.1"

            - name: Get PR Info
              id: pr
              uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
              with:
                  script: |
                      const pr = context.payload.workflow_run.pull_requests[0];
                      core.setOutput('number', pr.number);
                      core.setOutput('head_sha', pr.head.sha);

            - name: Collect CI Status
              id: ci
              uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
              with:
                  script: |
                      const { data: checks } = await github.rest.checks.listForRef({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        ref: '${{ steps.pr.outputs.head_sha }}'
                      });

                      const status = checks.check_runs.map(c => ({
                        name: c.name,
                        status: c.status,
                        conclusion: c.conclusion
                      }));

                      core.setOutput('status', JSON.stringify(status));

            - name: Run REQUIREMENTS.md Compliance Review
              uses: anthropics/claude-code-action@a7e4c51380c42dd89b127f5e5f9be7b54020bc6b # v1
              with:
                  claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
                  prompt: |
                      Perform comprehensive REQUIREMENTS.md compliance review for PR #${{ steps.pr.outputs.number }}.

                      CI Status: ${{ steps.ci.outputs.status }}

                      ## COMPLIANCE CHECKS

                      Read REQUIREMENTS.md and check the PR diff for violations:

                      ### Forbidden Patterns (MUST fail review if found)
                      1. `any` type usage (except type assertions with justification)
                      2. `var` or `let` declarations (must use `const`)
                      3. `if/else` chains (must use dispatch tables or ternaries)
                      4. `for`/`while` loops (must use .map/.filter/Effect)
                      5. `try/catch` blocks (must use Effect error channel)
                      6. `console.log` in production code (allowed in tools/ and scripts/)

                      ### Required Patterns
                      1. B constant pattern - single frozen object for all config
                      2. Dispatch tables for mode/type switching
                      3. Effect.Effect<T, E, R> for async operations
                      4. Option.match for nullable handling
                      5. Section separators (77-char `// --- Name ---`) for files >50 LOC

                      ### Exemptions
                      - `*.config.ts` files: default exports allowed
                      - `*.spec.ts`/`*.test.ts` files: test utilities allowed
                      - `plugins/*` files: side effects allowed

                      ## OUTPUT FORMAT

                      Generate a review with this structure:

                      ### Compliance Summary

                      | Rule | Status | Details |
                      |------|--------|---------|
                      (one row per check)

                      ### Violations (if any)
                      - File: path/to/file.ts:line
                      - Rule: [rule name]
                      - Code: `offending code`
                      - Fix: [suggested fix]

                      ### Recommendations
                      (non-blocking suggestions)

                      Use `gh pr review ${{ steps.pr.outputs.number }}` with:
                      - `--approve` if ALL mandatory checks pass
                      - `--request-changes` if ANY violation found

                  claude_args: |
                      --model claude-opus-4-5-20251101
                      --max-turns 10
                      --allowedTools Read,Grep,Glob,Bash(pnpm:*),Bash(git diff:*),Bash(gh pr:*)

            - name: Trigger Aggregator
              if: always()
              uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
              with:
                  script: |
                      await github.rest.actions.createWorkflowDispatch({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        workflow_id: 'pr-review-aggregator.yml',
                        ref: 'main'
                      });
