name: Issue Lifecycle

on:
    issues:
        types: [opened, edited, reopened]
    schedule:
        - cron: "0 */6 * * *" # Every 6 hours

concurrency:
    group: issue-lifecycle-${{ github.event.issue.number || 'scheduled' }}
    cancel-in-progress: false

permissions:
    contents: read
    issues: write

jobs:
    quality-review:
        if: github.event_name == 'issues'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
              with:
                  sparse-checkout: |
                      .github/scripts
                      package.json
                      pnpm-lock.yaml
                  sparse-checkout-cone-mode: false

            - name: Setup pnpm
              uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0

            - name: Setup Node.js
              uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
              with:
                  node-version-file: package.json
                  cache: pnpm

            - name: Quality Review
              uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
              with:
                  script: |
                      const { run } = await import('${{ github.workspace }}/.github/scripts/review.ts');
                      await run({
                        context: {
                          repo: context.repo,
                          payload: context.payload
                        },
                        core,
                        github
                      });

    stale-management:
        if: github.event_name == 'schedule'
        runs-on: ubuntu-latest
        steps:
            - name: Mark Stale Issues
              uses: actions/stale@5f858e3efba33a5ca4407a664cc011ad407f2008 # v10.1.0
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}
                  stale-issue-message: |
                      This issue has been automatically marked as stale due to inactivity.
                      It will be closed in 14 days if there is no further activity.
                      Comment to keep it open.
                  stale-pr-message: |
                      This PR has been automatically marked as stale due to inactivity.
                      It will be closed in 14 days if there is no further activity.
                  stale-issue-label: stale
                  stale-pr-label: stale
                  days-before-stale: 30
                  days-before-close: 14
                  exempt-issue-labels: pinned,security,critical,implement,needs-info
                  exempt-pr-labels: pinned,security,critical

            - name: Checkout
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
              with:
                  sparse-checkout: |
                      .github/scripts
                      package.json
                      pnpm-lock.yaml
                  sparse-checkout-cone-mode: false

            - name: Setup pnpm
              uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0

            - name: Setup Node.js
              uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
              with:
                  node-version-file: package.json
                  cache: pnpm

            - name: Generate Aging Report
              uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
              with:
                  script: |
                      const { run } = await import('${{ github.workspace }}/.github/scripts/report.ts');
                      await run({
                        context: { repo: context.repo, payload: { action: 'scheduled', issue: {} } },
                        core,
                        github,
                        spec: { kind: 'aging' }
                      });
