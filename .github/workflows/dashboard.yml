name: Repository Dashboard

on:
    schedule:
        - cron: '0 */6 * * *' # Every 6 hours
    workflow_dispatch:
    issues:
        types: [edited]

permissions:
    actions: read
    contents: read
    issues: write
    pull-requests: read

concurrency:
    group: dashboard
    cancel-in-progress: false

jobs:
    update-dashboard:
        name: Update Repository Dashboard
        runs-on: ubuntu-latest
        # Run on schedule, workflow_dispatch, or checkbox checked on dashboard issue
        if: |
            github.event_name == 'schedule' ||
            github.event_name == 'workflow_dispatch' ||
            (github.event_name == 'issues' &&
             contains(github.event.issue.labels.*.name, 'dashboard') &&
             contains(github.event.issue.body, '[x] <!-- dashboard-refresh -->'))
        steps:
            - name: Checkout
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v6

            - name: Setup Environment
              uses: ./.github/actions/node-env

            - name: Update Dashboard
              uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
              with:
                  script: |
                      const { run } = await import('${{ github.workspace }}/.github/scripts/dashboard.ts');
                      await run({
                        context: { repo: context.repo, payload: context.payload },
                        core,
                        github,
                        spec: { kind: 'update', pin: true }
                      });
