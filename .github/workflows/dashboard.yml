name: Repository Dashboard

on:
  schedule:
    # Run at :00 (passive-qc runs at :15 to avoid race conditions)
    - cron: '0 */6 * * *'
  workflow_dispatch:
  issues:
    types: [edited]

permissions:
  actions: read
  contents: read
  issues: write
  pull-requests: read

concurrency:
  group: dashboard
  cancel-in-progress: false

jobs:
  update-dashboard:
    name: Update Repository Dashboard
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' &&
       contains(github.event.issue.labels.*.name, 'dashboard') &&
       contains(github.event.issue.body, '[x] <!-- dashboard-refresh -->'))
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          sparse-checkout: |
            .github/scripts
            .github/actions
            package.json
            pnpm-workspace.yaml
            pnpm-lock.yaml
            nx.json

      - uses: ./.github/actions/node-env
        with:
          node-version-file: package.json

      - uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        env:
          NODE_OPTIONS: --import tsx
        with:
          script: |
            const { run } = await import('${{ github.workspace }}/.github/scripts/dashboard.ts');
            await run({
              context: { repo: context.repo, payload: context.payload },
              core,
              github,
              spec: { kind: 'update', pin: true }
            });
