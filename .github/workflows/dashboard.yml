name: Repository Dashboard

on:
    schedule:
        - cron: '0 */6 * * *' # Every 6 hours
    workflow_dispatch:
    issue_comment:
        types: [created]

permissions:
    actions: read
    contents: read
    issues: write
    pull-requests: read

concurrency:
    group: dashboard
    cancel-in-progress: false

jobs:
    update-dashboard:
        name: Update Repository Dashboard
        runs-on: ubuntu-latest
        # Run on schedule, workflow_dispatch, or /update command on dashboard issue
        if: |
            github.event_name == 'schedule' ||
            github.event_name == 'workflow_dispatch' ||
            (github.event_name == 'issue_comment' &&
             contains(github.event.comment.body, '/update') &&
             contains(github.event.issue.labels.*.name, 'dashboard'))
        steps:
            - name: Checkout
              uses: actions/checkout@c2d88d3ecc89a9ef08eebf45d9637801dcee7eb5 # v6

            - name: Setup Environment
              uses: ./.github/actions/setup

            - name: Update Dashboard
              uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
              with:
                  script: |
                      const { run } = await import('${{ github.workspace }}/.github/scripts/dashboard.ts');
                      await run({
                        context: { repo: context.repo, payload: context.payload },
                        core,
                        github,
                        spec: { kind: 'update', pin: true }
                      });
