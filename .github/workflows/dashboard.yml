name: Repository Dashboard

on:
    schedule:
        - cron: '0 */6 * * *'
    workflow_dispatch:
    issues:
        types: [edited]

permissions:
    actions: read
    contents: read
    issues: write
    pull-requests: read

concurrency:
    group: dashboard
    cancel-in-progress: false

jobs:
    update-dashboard:
        name: Update Repository Dashboard
        runs-on: ubuntu-latest
        if: |
            github.event_name == 'schedule' ||
            github.event_name == 'workflow_dispatch' ||
            (github.event_name == 'issues' &&
             contains(github.event.issue.labels.*.name, 'dashboard') &&
             contains(github.event.issue.body, '[x] <!-- dashboard-refresh -->'))
        steps:
            - uses: actions/checkout@v4
              with:
                  sparse-checkout: |
                      .github/scripts
                      .github/actions
                      package.json
                      pnpm-workspace.yaml
                      nx.json

            - uses: ./.github/actions/node-env

            - uses: actions/github-script@v7
              env:
                  NODE_OPTIONS: --import tsx
              with:
                  script: |
                      const { run } = await import('${{ github.workspace }}/.github/scripts/dashboard.ts');
                      await run({
                        context: { repo: context.repo, payload: context.payload },
                        core,
                        github,
                        spec: { kind: 'update', pin: true }
                      });
