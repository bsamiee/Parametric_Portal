# --- LETSENCRYPT CLUSTERISSUER (AZURE DNS) -----------------------------------
# DNS-01 challenge solver for wildcard and custom domain certificates
# Requires: Azure managed identity or service principal with DNS Zone Contributor
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
  labels:
    app.kubernetes.io/name: letsencrypt
    app.kubernetes.io/component: tls
    app.kubernetes.io/part-of: platform
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: ${LETSENCRYPT_EMAIL}  # REPLACE: admin email for cert notifications
    privateKeySecretRef:
      name: letsencrypt-prod-key

    solvers:
      - dns01:
          azureDNS:
            subscriptionID: ${AZURE_SUBSCRIPTION_ID}  # REPLACE: Azure subscription
            resourceGroupName: ${AZURE_RESOURCE_GROUP}  # REPLACE: Resource group containing DNS zone
            hostedZoneName: ${AZURE_DNS_ZONE}  # REPLACE: DNS zone name (e.g., example.com)
            environment: AzurePublicCloud
            managedIdentity:
              clientID: ${AZURE_MANAGED_IDENTITY_CLIENT_ID}  # REPLACE: Managed identity client ID
---
# --- LETSENCRYPT STAGING (FOR TESTING) ---------------------------------------
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-staging
  labels:
    app.kubernetes.io/name: letsencrypt
    app.kubernetes.io/component: tls
    app.kubernetes.io/part-of: platform
spec:
  acme:
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    email: ${LETSENCRYPT_EMAIL}  # REPLACE: admin email
    privateKeySecretRef:
      name: letsencrypt-staging-key

    solvers:
      - dns01:
          azureDNS:
            subscriptionID: ${AZURE_SUBSCRIPTION_ID}
            resourceGroupName: ${AZURE_RESOURCE_GROUP}
            hostedZoneName: ${AZURE_DNS_ZONE}
            environment: AzurePublicCloud
            managedIdentity:
              clientID: ${AZURE_MANAGED_IDENTITY_CLIENT_ID}
