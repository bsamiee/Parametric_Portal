# --- MINIO TENANT (PLATFORM STORAGE) ------------------------------------------
# S3-compatible object storage for projects
# Based on official example: github.com/minio/operator/examples/kustomization/base/tenant.yaml
apiVersion: minio.min.io/v2
kind: Tenant
metadata:
  name: platform-storage
  namespace: minio-system
  labels:
    app: minio
    app.kubernetes.io/name: minio
    app.kubernetes.io/component: storage
    app.kubernetes.io/part-of: platform
  annotations:
    prometheus.io/path: /minio/v2/metrics/cluster
    prometheus.io/port: "9000"
    prometheus.io/scrape: "true"
spec:
  # --- [FEATURES] ------------------------------------------------------------
  features:
    bucketDNS: false
    domains: {}

  # --- [USERS] ---------------------------------------------------------------
  users:
    - name: platform-storage-user

  # --- [CERTIFICATES] --------------------------------------------------------
  certConfig: {}

  # --- [POD_MANAGEMENT] ------------------------------------------------------
  podManagementPolicy: Parallel

  # --- [CONFIGURATION] -------------------------------------------------------
  configuration:
    name: platform-storage-config

  # --- [ENVIRONMENT] ---------------------------------------------------------
  env: []

  # --- [SERVICE_METADATA] ----------------------------------------------------
  serviceMetadata:
    minioServiceLabels: {}
    minioServiceAnnotations: {}
    consoleServiceLabels: {}
    consoleServiceAnnotations: {}

  # --- [PRIORITY] ------------------------------------------------------------
  priorityClassName: ""

  # --- [CERTIFICATES] --------------------------------------------------------
  externalCaCertSecret: []
  externalCertSecret: []
  externalClientCertSecrets: []

  # --- [IMAGE] ---------------------------------------------------------------
  image: quay.io/minio/minio:RELEASE.2024-12-18T13-15-44Z
  imagePullSecret: {}

  # --- [MOUNT] ---------------------------------------------------------------
  mountPath: /export
  subPath: ""

  # --- [SERVICE_ACCOUNT] -----------------------------------------------------
  serviceAccountName: ""

  # --- [POOLS] ---------------------------------------------------------------
  pools:
    - servers: 4
      name: pool-0
      topologySpreadConstraints: []
      volumesPerServer: 2
      nodeSelector: {}
      tolerations: []

      # --- [AFFINITY] --------------------------------------------------------
      affinity:
        nodeAffinity: {}
        podAffinity: {}
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  v1.min.io/tenant: platform-storage
              topologyKey: kubernetes.io/hostname

      # --- [RESOURCES] -------------------------------------------------------
      resources:
        requests:
          cpu: 250m
          memory: 512Mi
        limits:
          cpu: 1000m
          memory: 1Gi

      # --- [VOLUME_CLAIM_TEMPLATE] -------------------------------------------
      volumeClaimTemplate:
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata: {}
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 50Gi
          storageClassName: longhorn
        status: {}

      # --- [SECURITY_CONTEXT] ------------------------------------------------
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        fsGroup: 1000
        fsGroupChangePolicy: "OnRootMismatch"

      # --- [CONTAINER_SECURITY_CONTEXT] --------------------------------------
      containerSecurityContext:
        runAsUser: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
        seccompProfile:
          type: RuntimeDefault

  # --- [AUTO_CERT] -----------------------------------------------------------
  requestAutoCert: true
---
# --- MINIO CONFIGURATION SECRET -----------------------------------------------
# Root credentials for MinIO admin access
# [IMPORTANT] Use ExternalSecrets Operator or SealedSecrets for production
# This placeholder secret allows local development; replace with ESO in overlays
apiVersion: v1
kind: Secret
metadata:
  name: platform-storage-config
  namespace: minio-system
  annotations:
    # Mark as placeholder - must be replaced by ESO/SealedSecrets before deployment
    parametric-portal.com/secret-source: "placeholder"
type: Opaque
stringData:
  config.env: |
    export MINIO_ROOT_USER="minio-admin"
    export MINIO_ROOT_PASSWORD="REPLACE_WITH_SEALED_SECRET"
    export MINIO_BROWSER="on"
    export MINIO_PROMETHEUS_AUTH_TYPE="public"
---
# --- MINIO USER SECRET ---------------------------------------------------------
# Additional user credentials
# [IMPORTANT] Use ExternalSecrets Operator or SealedSecrets for production
apiVersion: v1
kind: Secret
metadata:
  name: platform-storage-user
  namespace: minio-system
  annotations:
    parametric-portal.com/secret-source: "placeholder"
type: Opaque
stringData:
  CONSOLE_ACCESS_KEY: "storage-user"
  CONSOLE_SECRET_KEY: "REPLACE_WITH_SEALED_SECRET"
